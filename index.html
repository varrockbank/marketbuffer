<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketbuffer</title>
  <script src="vendor/buffer.js"></script>
  <script src="snap-grid.js"></script>
  <script src="os.js"></script>
  <script src="file-tree.js"></script>
  <script src="app-launcher.js"></script>
  <link rel="stylesheet" href="vendor/buffer.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Chicago&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-color: #a8a8a8;
      --window-bg: #fff;
      --window-border: #000;
      --title-bar-bg: #c0c0c0;
      --text-color: #000;
      --text-muted: #666;
      --menu-bg: #fff;
      --menu-border: #000;
      --sidebar-bg: #e8e8e8;
      --input-bg: #fff;
      --input-border: #000;
      --hover-bg: #e0e0e0;
      --selected-bg: #c0c0c0;
      --pane-bg: #fff;
      --diff-added: #d4edda;
      --diff-removed: #f8d7da;
      --diff-added-text: #155724;
      --diff-removed-text: #721c24;
      --diff-header-bg: #e8e8fc;
    }

    body.dark-theme {
      --bg-color: #1e1e1e;
      --window-bg: #2d2d2d;
      --window-border: #555;
      --title-bar-bg: #3c3c3c;
      --text-color: #e0e0e0;
      --text-muted: #888;
      --menu-bg: #2d2d2d;
      --menu-border: #555;
      --sidebar-bg: #252525;
      --input-bg: #3c3c3c;
      --input-border: #555;
      --hover-bg: #404040;
      --selected-bg: #505050;
      --pane-bg: #1e1e1e;
      --diff-added: #2d4a3e;
      --diff-removed: #4a2d2d;
      --diff-added-text: #8fdf8f;
      --diff-removed-text: #df8f8f;
      --diff-header-bg: #3c3c5c;
    }

    body {
      font-family: 'Chicago', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      background: var(--bg-color);
      min-height: 100vh;
      cursor: default;
      color: var(--text-color);
      user-select: none;
    }

    /* Font size classes - affects sidebar and menu only */
    body.font-small .menu-bar,
    body.font-small .primary-sidebar,
    body.font-small .sidebar-section-header,
    body.font-small .sidebar-item,
    body.font-small .sidebar-footer,
    body.font-small .tree-item-row { font-size: 10px; }
    body.font-medium .menu-bar,
    body.font-medium .primary-sidebar,
    body.font-medium .sidebar-section-header,
    body.font-medium .sidebar-item,
    body.font-medium .sidebar-footer,
    body.font-medium .tree-item-row { font-size: 12px; }
    body.font-large .menu-bar,
    body.font-large .primary-sidebar,
    body.font-large .sidebar-section-header,
    body.font-large .sidebar-item,
    body.font-large .sidebar-footer,
    body.font-large .tree-item-row { font-size: 14px; }

    /* Menu Bar */
    .menu-bar {
      position: relative;
      background: var(--menu-bg);
      border-bottom: 2px solid var(--menu-border);
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px;
      flex-shrink: 0;
    }

    .menu-bar-left {
      display: flex;
      align-items: center;
      height: 100%;
    }

    .sidebar-toggle-container {
      display: none;
    }

    .menu-bar-right {
      display: flex;
      align-items: center;
    }

    .menu-item {
      padding: 6px 12px;
      cursor: pointer;
    }

    .menu-item-bold {
      font-weight: bold;
    }

    .menu-item:hover,
    .menu-item.active {
      background: var(--text-color);
      color: var(--window-bg);
    }

    /* Workspace tabs container */
    .workspace-tabs-container {
      display: flex;
      align-items: center;
      height: 100%;
    }

    /* Separator between tabs */
    .workspace-tab-separator {
      color: var(--window-border);
      margin: 0 4px;
      user-select: none;
    }

    /* Individual workspace tab */
    .workspace-tab {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 4px 2px 4px;
      margin: 0 6px;
      cursor: pointer;
      width: 200px;
      box-sizing: border-box;
      border-radius: 4px;
    }

    .workspace-tab-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
      text-align: center;
    }

    .workspace-tab:hover {
      background: rgba(0, 0, 0, 0.1);
    }

    .workspace-tab-close {
      opacity: 0;
      font-size: 12px;
      padding: 0 4px;
      height: 14px;
      line-height: 14px;
      border-radius: 3px;
      flex-shrink: 0;
      position: relative;
      top: -2px;
    }

    .workspace-tab:hover .workspace-tab-close {
      opacity: 0.6;
    }

    .workspace-tab-close:hover {
      opacity: 1 !important;
      background: rgba(0, 0, 0, 0.1);
    }

    .workspace-tab.active .workspace-tab-close {
      top: 0px;
    }

    /* Active workspace tab */
    .workspace-tab.active {
      top: 0px;
      background: var(--window-bg);
      padding: 3px 4px 4px 4px;
      margin: 0 6px -6px 6px;
      border: 1px solid var(--window-border);
      border-bottom: none;
      border-radius: 6px 6px 0 0;
      width: 200px;
      max-width: 200px;
      box-sizing: border-box;
    }

    .workspace-tab.active:hover {
      background: var(--window-bg);
    }

    .workspace-tab.active::before,
    .workspace-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      width: 6px;
      height: 6px;
    }

    .workspace-tab.active::before {
      left: -6px;
      background: radial-gradient(circle at 0 0, transparent 5px, var(--window-border) 5px, var(--window-border) 6px, var(--window-bg) 6px);
    }

    .workspace-tab.active::after {
      right: -6px;
      background: radial-gradient(circle at 100% 0, transparent 5px, var(--window-border) 5px, var(--window-border) 6px, var(--window-bg) 6px);
    }

    /* Add workspace button */
    .workspace-add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      margin-left: 4px;
      margin-top: 2px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      line-height: 1;
      padding-bottom: 2px;
      color: var(--text-color);
      opacity: 0.6;
      position: relative;
      top: -2px;
    }

    .workspace-add-btn:hover {
      background: var(--hover-bg);
      opacity: 1;
    }

    .menu-item-container {
      position: relative;
    }


    .menu-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--menu-bg);
      border: 1px solid var(--menu-border);
      box-shadow: 2px 2px 0 var(--menu-border);
      min-width: 180px;
      z-index: 1001;
    }

    .menu-dropdown.open {
      display: block;
    }

    .menu-dropdown.right-align {
      left: auto;
      right: 0;
    }

    .menu-dropdown-item {
      padding: 4px 12px 4px 24px;
      cursor: pointer;
      position: relative;
      white-space: nowrap;
      color: var(--text-color);
    }

    .menu-dropdown-item:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .menu-dropdown-item.checked::before {
      content: '✓';
      position: absolute;
      left: 8px;
    }

    .menu-dropdown-separator {
      height: 1px;
      background: var(--window-border);
      margin: 4px 0;
    }

    /* App Launcher Drawer */
    .app-launcher {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--menu-bg);
      border-top: 1px solid var(--menu-border);
      border-bottom: 1px solid var(--menu-border);
      padding: 0 24px;
      overflow: hidden;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 0;
      opacity: 0;
      transition: max-height 0.5s ease, opacity 0.5s ease, padding 0.5s ease;
    }

    .app-launcher.open {
      max-height: 200px;
      opacity: 1;
      padding: 16px 24px;
      overflow-x: auto;
    }

    .app-launcher-overflow-indicator {
      display: none;
      position: fixed;
      width: 48px;
      height: 48px;
      background: var(--text-color);
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      z-index: 1002;
    }

    .app-launcher-overflow-indicator.visible {
      display: flex;
    }

    .app-launcher-overflow-indicator.right {
      right: 24px;
    }

    .app-launcher-overflow-indicator.left {
      left: 324px;
    }

    .app-launcher-overflow-indicator svg {
      width: 24px;
      height: 24px;
      stroke: var(--menu-bg);
    }

    .app-launcher-overflow-indicator.left svg {
      transform: rotate(180deg);
    }


    .app-launcher-grid {
      display: flex;
      gap: 24px;
      justify-content: flex-start;
    }

    .app-launcher-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 12px;
      border-radius: 8px;
      min-width: 80px;
      transition: background 0.15s ease;
    }

    .app-launcher-item:hover {
      background: var(--hover-bg);
    }

    .app-launcher-item.active {
      background: var(--hover-bg);
    }

    .app-launcher-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--window-bg);
      border: 1px solid var(--menu-border);
      border-radius: 12px;
      font-size: 24px;
    }

    .app-launcher-icon svg {
      width: 28px;
      height: 28px;
      stroke: currentColor;
      fill: none;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .app-launcher-label {
      font-size: 12px;
      color: var(--text-color);
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    /* Sidebar Toggle Button */
    .sidebar-toggle {
      width: 44px;
      height: 28px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-toggle:hover {
      background: var(--hover-bg);
    }

    .sidebar-toggle svg {
      display: block;
    }

    .sidebar-toggle.collapsed svg {
      transform: scaleX(-1);
    }

    /* Primary Sidebar Container */
    .sidebar-container {
      flex-shrink: 0;
      overflow: visible;
      width: 160px;
      transition: width 0.3s ease-in-out;
      z-index: 100;
    }

    .sidebar-container.collapsed {
      width: 44px;
    }

    /* Primary Sidebar */
    .primary-sidebar {
      width: 100%;
      height: 100%;
      background: var(--window-bg);
      border-right: 2px solid var(--window-border);
      display: flex;
      flex-direction: column;
      overflow: visible;
    }

    /* Sidebar Header with Toggle */
    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 8px;
      height: 44px;
      flex-shrink: 0;
      padding: 0 8px;
      margin-bottom: 8px;
      position: relative;
    }

    .sidebar-header .sidebar-toggle {
      position: absolute;
      right: 8px;
    }

    .sidebar-container.collapsed .sidebar-header .sidebar-toggle {
      right: auto;
      left: 50%;
      transform: translateX(-50%);
    }



    /* Project Selector */
    .project-selector {
      position: relative;
      flex: 1;
    }

    .project-selector-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0;
      cursor: pointer;
      font-size: 13px;
      border-radius: 4px;
      width: 100%;
    }

    .project-selector-btn:hover {
      background: transparent;
    }

    .project-selector-btn svg {
      flex-shrink: 0;
    }


    .project-dropdown {
      display: none;
      position: fixed;
      background: var(--menu-bg);
      border: 1px solid var(--menu-border);
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .project-dropdown.open {
      display: block;
    }

    .project-dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-color);
    }

    .project-dropdown-item:hover {
      background: var(--hover-bg);
    }

    .project-dropdown-item .checkmark {
      width: 16px;
      flex-shrink: 0;
    }

    .project-dropdown-separator {
      height: 1px;
      background: var(--menu-border);
      margin: 4px 12px;
    }

    .project-dropdown-item.new-project {
      color: #83C18D;
    }

    .sidebar-separator {
      height: 1px;
      background: var(--window-border);
      margin: 8px 12px;
    }

    .sidebar-section {
    }

    .sidebar-section-header {
      padding: 8px 12px;
      font-weight: bold;
      font-size: 11px;
    }

    .sidebar-section-header,
    .pinned-files,
    .file-tree,
    #pinned-section,
    .sidebar-section-files,
    .sidebar-separator {
      transition: opacity 0.1s ease-out 0.2s;
    }

    .sidebar-container.collapsed .sidebar-section-header,
    .sidebar-container.collapsed .pinned-files,
    .sidebar-container.collapsed .file-tree,
    .sidebar-container.collapsed #pinned-section,
    .sidebar-container.collapsed .sidebar-section-files,
    .sidebar-container.collapsed .sidebar-separator {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.1s ease-out;
    }

    .sidebar-item {
      padding: 6px 12px 6px 6px;
      font-size: 11px;
      cursor: pointer;
      position: relative;
    }

    .sidebar-item:hover {
      background: transparent;
    }

    .sidebar-item.active {
      background: transparent;
    }

    .sidebar-item-inner {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      border-radius: 4px;
      transition: all 0.1s ease-out;
    }

    .sidebar-item:hover .sidebar-item-inner {
      background: #000;
      color: #fff;
    }

    .sidebar-item.active .sidebar-item-inner {
      background: var(--selected-bg);
      box-shadow:
        inset -1px -1px 0 0 var(--window-border),
        inset 1px 1px 0 0 rgba(255,255,255,0.2);
    }

    .sidebar-item-icon {
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
    }
    .sidebar-item-label,
    .user-menu-btn .user-name,
    .user-menu-btn .user-chevron,
    .project-selector {
      transition: opacity 0.1s ease-out 0.2s;
    }

    .sidebar-container.collapsed .sidebar-item-label,
    .sidebar-container.collapsed .user-menu-btn .user-name,
    .sidebar-container.collapsed .user-menu-btn .user-chevron,
    .sidebar-container.collapsed .project-selector {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.1s ease-out;
    }

    /* Keep icons stationary when sidebar is collapsed */
    .sidebar-container.collapsed .sidebar-scrollable {
      overflow-x: hidden;
    }

    .sidebar-container.collapsed .sidebar-footer {
      padding: 10px 12px 10px 11px;
    }

    /* Allow tooltips to overflow when collapsed */
    .sidebar-container.collapsed .primary-sidebar {
      overflow: visible;
    }

    .sidebar-container.collapsed .sidebar-scrollable {
      overflow: visible;
    }

    .sidebar-container.collapsed #nav-section {
      overflow: visible;
    }

    /* Center icons when collapsed */
    .sidebar-container.collapsed .sidebar-item .sidebar-item-icon {
      left: 4px;
    }

    /* Tooltips for collapsed sidebar */
    .sidebar-container.collapsed .sidebar-item {
      position: relative;
    }

    .sidebar-container.collapsed .sidebar-item::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 45px;
      top: 50%;
      transform: translateY(-50%);
      padding: 4px 8px;
      background: #000;
      color: #fff;
      border-radius: 4px;
      box-shadow: 2px 2px 0 0 rgba(0, 0, 0, 0.15);
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease-out;
      z-index: 1000;
    }

    .sidebar-container.collapsed .sidebar-item:hover::after {
      opacity: 1;
    }

    #nav-section .sidebar-item .sidebar-item-icon {
      transition: transform 0.15s ease-out;
    }

    #nav-section .sidebar-item:hover .sidebar-item-icon {
      transform: rotate(30deg);
    }

    #search-item .sidebar-item-icon {
      transition: transform 0.15s ease-out;
    }

    #search-item:hover .sidebar-item-icon {
      transform: rotate(30deg);
    }

    #new-chat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px 10px 13px;
      font-size: 13px;
      height: 36px;
      box-sizing: border-box;
    }

    #new-chat-item .sidebar-item-icon {
      background: #7A68AA;
      color: #fff;
      border-radius: 4px;
    }

    #new-chat-item:hover .sidebar-item-icon {
      background: #6a5a96;
    }

    #nav-section .sidebar-item {
      padding: 2px 8px;
    }

    #nav-section .sidebar-item-icon {
      position: static;
      transform: none;
      flex-shrink: 0;
    }


    .sidebar-spacer {
      flex: 1;
    }

    /* Sidebar Scrollable Content */
    .sidebar-scrollable {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    /* File Tree */
    .file-tree {
      flex: 1;
      padding: 4px 0;
    }

    .tree-item {
      cursor: pointer;
      white-space: nowrap;
    }

    .tree-item-row {
      display: flex;
      align-items: center;
      padding: 3px 8px;
      font-size: 11px;
      position: relative;
    }

    .tree-item-row:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .tree-item-row:has(.tree-file-menu-btn:hover),
    .tree-item-row:has(.tree-item-menu.open) {
      background: transparent;
      color: var(--text-color);
    }

    .tree-item-row.selected {
      background: var(--selected-bg);
    }

    .tree-toggle {
      width: 12px;
      height: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      flex-shrink: 0;
      margin-right: 2px;
    }

    .tree-icon {
      width: 14px;
      height: 14px;
      margin-right: 4px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .tree-label {
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .tree-pin {
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      opacity: 0;
      cursor: pointer;
      margin-left: auto;
    }

    .tree-item-row:hover .tree-pin {
      opacity: 0.5;
    }

    .tree-pin:hover {
      opacity: 1 !important;
    }

    .tree-pin.pinned {
      opacity: 1;
    }

    /* Tree File Menu Button */
    .tree-file-menu-btn {
      opacity: 0;
      background: none;
      border: none;
      padding: 0 4px;
      margin: -3px -8px -3px auto;
      align-self: stretch;
      cursor: pointer;
      color: inherit;
      display: flex;
      align-items: center;
    }

    .tree-file-menu-btn svg {
      width: 16px;
      height: 16px;
    }

    .tree-item-row:hover .tree-file-menu-btn {
      opacity: 1;
    }

    .tree-item-row:has(.tree-file-menu-btn:hover),
    .tree-item-row:has(.tree-item-menu.open) {
      background: transparent;
      color: var(--text-color);
    }

    .tree-item-row:has(.tree-file-menu-btn:hover) .tree-file-menu-btn,
    .tree-item-row:has(.tree-item-menu.open) .tree-file-menu-btn {
      opacity: 1;
    }

    .tree-file-menu-btn:hover,
    .tree-item-row:has(.tree-item-menu.open) .tree-file-menu-btn {
      background: var(--text-color);
      color: var(--window-bg);
    }

    /* Tree Item Context Menu */
    .tree-item-menu {
      display: none;
      position: fixed;
      min-width: 120px;
      background: var(--menu-bg);
      border: 1px solid var(--menu-border);
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .tree-item-menu.open {
      display: block;
    }

    .tree-item-menu-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-color);
    }

    .tree-item-menu-option .menu-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .tree-item-menu-option .menu-icon svg {
      width: 16px;
      height: 16px;
    }

    .tree-item-menu-option:hover {
      background: var(--hover-bg);
    }

    .tree-item-menu-option.delete {
      color: #e55;
    }

    .tree-item-menu-separator {
      height: 1px;
      background: var(--menu-border);
      margin: 4px 12px;
    }

    .pinned-item {
      display: flex;
      align-items: center;
      padding: 6px 12px 6px 13px;
      font-size: 11px;
      cursor: pointer;
      position: relative;
      gap: 8px;
    }

    .pinned-item:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .pinned-item:has(.pinned-item-menu-btn:hover),
    .pinned-item:has(.pinned-item-menu.open) {
      background: transparent;
      color: var(--text-color);
    }

    .pinned-item-icon {
      font-size: 10px;
      flex-shrink: 0;
      width: 16px;
      text-align: center;
    }

    .pinned-item-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pinned-item-menu-btn {
      opacity: 0;
      cursor: pointer;
      font-size: 14px;
      padding: 0 12px;
      margin: -6px -12px -6px 0;
      display: flex;
      align-items: center;
      align-self: stretch;
    }

    .pinned-item:hover .pinned-item-menu-btn {
      opacity: 1;
      color: var(--window-bg);
    }

    .pinned-item:has(.pinned-item-menu-btn:hover) .pinned-item-menu-btn,
    .pinned-item:has(.pinned-item-menu.open) .pinned-item-menu-btn {
      opacity: 1;
      color: var(--text-color);
    }

    .pinned-item-menu-btn:hover,
    .pinned-item:has(.pinned-item-menu.open) .pinned-item-menu-btn {
      background: var(--text-color);
      color: var(--window-bg) !important;
    }

    /* Pinned Item Context Menu */
    .pinned-item-menu {
      display: none;
      position: absolute;
      right: 8px;
      top: 100%;
      min-width: 120px;
      background: var(--menu-bg);
      border: 1px solid var(--menu-border);
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      margin-top: 2px;
    }

    .pinned-item-menu.open {
      display: block;
    }

    .pinned-item-menu-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-color);
    }

    .pinned-item-menu-option .menu-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .pinned-item-menu-option .menu-icon svg {
      width: 16px;
      height: 16px;
    }

    .pinned-item-menu-option:hover {
      background: var(--hover-bg);
    }

    .pinned-item-menu-option.delete {
      color: #e55;
    }

    .pinned-item-menu-separator {
      height: 1px;
      background: var(--menu-border);
      margin: 4px 12px;
    }

    .tree-children {
      display: none;
    }

    .tree-children.expanded {
      display: block;
    }

    .tree-item[data-depth="0"] > .tree-item-row { padding-left: 8px; }
    .tree-item[data-depth="1"] > .tree-item-row { padding-left: 22px; }
    .tree-item[data-depth="2"] > .tree-item-row { padding-left: 36px; }
    .tree-item[data-depth="3"] > .tree-item-row { padding-left: 50px; }
    .tree-item[data-depth="4"] > .tree-item-row { padding-left: 64px; }

    .sidebar-actions {
      padding: 8px 0 0 0;
      overflow: visible;
    }

    .sidebar-actions .sidebar-item {
      padding: 2px 8px;
    }

    .sidebar-actions .sidebar-item.disabled {
      opacity: 0.4;
      pointer-events: none;
      cursor: default;
    }

    .sidebar-actions .sidebar-separator {
      margin: 8px 20px;
    }

    /*
     * TOGGLE BUTTON - Special case
     * Expanded: "Marketbuffer" title on left, toggle icon on right
     * Collapsed: title fades out, toggle icon slides to left (aligns with other icons)
     * Uses absolute positioning for toggle so it animates independently
     */
    #sidebar-toggle-btn {
      position: relative;
      overflow: visible;
    }

    /* Title: "M" + "arketbuffer" */
    #sidebar-toggle-btn .sidebar-item-inner {
      gap: 0;
      opacity: 1;
      transition: opacity 0.3s ease-in-out;
    }

    #sidebar-toggle-btn .sidebar-item-label {
      font-family: Georgia, 'Times New Roman', serif;
      font-weight: 300;
      font-size: 16px;
      margin-left: -4px;
    }

    #sidebar-toggle-btn .title-icon {
      font-family: Georgia, 'Times New Roman', serif;
      font-weight: 300;
      font-size: 16px;
      width: auto;
      height: auto;
      display: inline-block;
      margin-left: 1px;
      margin-right: 4px;
      transition: transform 0.15s ease-out;
    }

    #sidebar-toggle-btn:hover .sidebar-item-inner,
    #sidebar-toggle-btn .sidebar-item-inner:hover {
      background: transparent;
      box-shadow: none;
      color: inherit;
    }

    #sidebar-toggle-btn.home-active .sidebar-item-inner {
      background: var(--selected-bg);
      box-shadow:
        inset -1px -1px 0 0 var(--window-border),
        inset 1px 1px 0 0 rgba(255,255,255,0.2);
    }

    /* Toggle icon - absolutely positioned, animates via 'left' */
    #sidebar-toggle-btn .toggle-icon-wrapper {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      right: 8px;
      left: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      border-radius: 4px;
      transition: left 0.3s ease-in-out, right 0.3s ease-in-out, background 0.1s ease-out;
      cursor: pointer;
    }

    #sidebar-toggle-btn .toggle-icon-wrapper:hover {
      background: #000;
      color: #fff;
    }

    #sidebar-toggle-btn .toggle-icon {
      display: block;
    }

    /* Tooltip for toggle icon */
    #sidebar-toggle-btn .toggle-icon-wrapper::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      margin-left: 10px;
      padding: 4px 8px;
      background: #000;
      color: #fff;
      border-radius: 4px;
      font-size: 12px;
      font-family: system-ui, -apple-system, sans-serif;
      font-weight: 400;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease-out;
      z-index: 10000;
    }

    #sidebar-toggle-btn .toggle-icon-wrapper:hover::after {
      opacity: 1;
    }

    .sidebar-container.animating #sidebar-toggle-btn .toggle-icon-wrapper::after {
      opacity: 0 !important;
      transition: none;
    }

    /* Collapsed state */
    .sidebar-container.collapsed .sidebar-actions {
      overflow: visible;
    }

    .sidebar-container.collapsed #sidebar-toggle-btn .sidebar-item-inner {
      opacity: 0;
      pointer-events: none;
    }

    .sidebar-container.collapsed #sidebar-toggle-btn .toggle-icon-wrapper {
      left: 8px;
      right: auto;
    }

    .sidebar-container.collapsed #sidebar-toggle-btn::after {
      display: none;
    }

    .sidebar-actions .sidebar-item-icon {
      position: static;
      transform: none;
      flex-shrink: 0;
    }

    .sidebar-actions .sidebar-item .sidebar-item-icon {
      transition: transform 0.15s ease-out;
    }

    .sidebar-actions .sidebar-item:hover .sidebar-item-icon {
      transform: rotate(30deg);
    }

    /* Exclude toggle button from general hover rotation */
    #sidebar-toggle-btn:hover .sidebar-item-icon {
      transform: none;
    }

    #sidebar-toggle-btn .sidebar-item-inner:hover .title-icon {
      transform: rotate(30deg);
    }

    #chat-toggle-btn .sidebar-item-icon {
      background: #7A68AA;
      color: #fff;
      border-radius: 4px;
    }

    #chat-toggle-btn:hover .sidebar-item-icon {
      background: #6a5a96;
    }

    .sidebar-footer {
      padding: 10px 12px 10px 11px;
      border-top: 1px solid var(--window-border);
      background: var(--sidebar-bg);
      position: relative;
    }

    .user-menu-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
      color: var(--text-color);
      white-space: nowrap;
    }

    .sidebar-footer:hover {
      background: var(--hover-bg);
    }

    .user-menu-btn .user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--window-bg);
      flex-shrink: 0;
    }

    .user-menu-btn .user-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }


    .user-menu {
      display: none;
      position: fixed;
      bottom: 54px;
      left: 8px;
      width: 164px;
      background: var(--menu-bg);
      border: 1px solid var(--menu-border);
      border-radius: 4px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.2);
      z-index: 10000;
    }

    .user-menu.open {
      display: block;
    }

    .user-menu-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-color);
    }

    .user-menu-option:hover {
      background: var(--hover-bg);
    }

    .user-menu-option .menu-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .user-menu-option .menu-icon svg {
      width: 16px;
      height: 16px;
    }

    .user-menu-separator {
      height: 1px;
      background: var(--menu-border);
      margin: 4px 12px;
    }

    .user-menu-email {
      padding: 8px 12px;
      font-size: 14px;
      color: var(--text-color);
      opacity: 0.7;
    }

    .user-menu-option.logout {
      color: #e55;
    }

    /* Language Submenu */
    .user-menu-option.has-submenu {
      position: relative;
    }

    .user-menu-option.has-submenu::after {
      content: '';
      border: 4px solid transparent;
      border-left-color: var(--text-color);
      margin-left: auto;
    }

    .language-submenu {
      display: none;
      position: absolute;
      left: 100%;
      top: 0;
      white-space: nowrap;
      background: var(--menu-bg);
      border: 1px solid var(--menu-border);
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1001;
      margin-left: 4px;
    }

    .user-menu-option.has-submenu:hover .language-submenu {
      display: block;
    }

    .language-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-color);
    }

    .language-option:hover {
      background: var(--hover-bg);
    }

    .language-option .checkmark {
      width: 16px;
      flex-shrink: 0;
    }

    /* Command Palette */
    .command-palette-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      padding-top: 15vh;
    }

    .command-palette-overlay.open {
      display: flex;
    }

    .command-palette {
      width: 100%;
      max-width: 560px;
      background: var(--menu-bg);
      border: 1px solid var(--menu-border);
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      max-height: 400px;
      display: flex;
      flex-direction: column;
    }

    .command-palette-input-wrapper {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--menu-border);
      gap: 12px;
    }

    .command-palette-input-wrapper svg {
      flex-shrink: 0;
      opacity: 0.5;
    }

    .command-palette-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-size: 16px;
      color: var(--text-color);
    }

    .command-palette-input::placeholder {
      color: var(--text-muted);
    }

    .command-palette-results {
      overflow-y: auto;
      flex: 1;
    }

    .command-palette-section {
      padding: 8px 0;
    }

    .command-palette-section-header {
      padding: 4px 16px 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .command-palette-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      cursor: pointer;
      color: var(--text-color);
    }

    .command-palette-item:hover,
    .command-palette-item.selected {
      background: var(--hover-bg);
    }

    .command-palette-item-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      opacity: 0.7;
    }

    .command-palette-item-label {
      flex: 1;
      font-size: 14px;
    }

    .command-palette-item-shortcut {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      gap: 4px;
    }

    .command-palette-item-shortcut kbd {
      background: var(--hover-bg);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: inherit;
      font-size: 11px;
    }

    /* App Layout - root container */
    .app-layout {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    /* Main Pane - contains menu bar and desktop */
    .main-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    /* Desktop Area (viewport + prompt) */
    .desktop-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    /* Desktop */
    .desktop {
      flex: 1;
      min-height: 0;
      position: relative;
      overflow: clip;
      overflow-x: visible;
    }

    /* Prompt Container */
    .prompt-container {
      flex-shrink: 0;
    }

    /* Desktop Icons */
    .desktop-icons {
      position: absolute;
      top: 30px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .desktop-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 64px;
      cursor: pointer;
    }

    .desktop-icon:hover .icon-label {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .icon-image {
      width: 32px;
      height: 32px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 4px;
    }

    .icon-label {
      font-size: 10px;
      text-align: center;
      padding: 1px 3px;
    }

    /* Window */
    .window {
      position: absolute;
      background: var(--window-bg);
      border: 2px solid var(--window-border);
      box-shadow: 2px 2px 0 var(--window-border);
      min-width: 300px;
      left: auto;
    }

    .window-title-bar {
      background: var(--title-bar-bg);
      border-bottom: 2px solid var(--window-border);
      padding: 2px 4px;
      display: flex;
      align-items: center;
      height: 20px;
    }

    .window-draggable .window-title-bar {
      cursor: move;
    }

    .window-title-bar::before,
    .window-title-bar::after {
      content: '';
      flex: 1;
      height: 10px;
      background: repeating-linear-gradient(
        0deg,
        var(--window-border),
        var(--window-border) 1px,
        var(--title-bar-bg) 1px,
        var(--title-bar-bg) 3px
      );
    }

    .window-title {
      padding: 0 8px;
      font-weight: bold;
      font-size: 12px;
      white-space: nowrap;
    }

    .close-box {
      width: 12px;
      height: 12px;
      border: 1px solid var(--window-border);
      background: var(--window-bg);
      margin-right: 4px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .close-box:hover {
      background: var(--text-color);
    }

    .window-content {
      padding: 16px;
      background: var(--window-bg);
    }

    /* Scrollbar styling for window */
    .window-scrollable {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--window-border);
      margin: 8px;
      background: var(--window-bg);
    }

    .window-scrollable::-webkit-scrollbar {
      width: 16px;
    }

    .window-scrollable::-webkit-scrollbar-track {
      background:
        repeating-linear-gradient(
          45deg,
          var(--window-bg),
          var(--window-bg) 2px,
          var(--bg-color) 2px,
          var(--bg-color) 4px
        );
      border-left: 1px solid var(--window-border);
    }

    .window-scrollable::-webkit-scrollbar-thumb {
      background: var(--window-bg);
      border: 1px solid var(--window-border);
    }

    /* Finder Window */
    .finder-window {
      top: 60px;
      left: 40px;
      width: 400px;
    }

    .finder-content {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      padding: 16px;
    }

    .finder-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
    }

    .finder-item:hover .finder-label {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .folder-icon {
      width: 32px;
      height: 26px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      position: relative;
      margin-bottom: 4px;
    }

    .folder-icon::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 2px;
      width: 14px;
      height: 6px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      border-bottom: none;
    }

    .document-icon {
      width: 24px;
      height: 32px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      position: relative;
      margin-bottom: 4px;
    }

    .document-icon::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 8px;
      height: 8px;
      background: var(--window-bg);
      border-left: 1px solid var(--window-border);
      border-bottom: 1px solid var(--window-border);
    }

    .finder-label {
      font-size: 10px;
      text-align: center;
      padding: 1px 3px;
    }

    /* About Window */
    .about-window {
      top: 120px;
      left: 120px;
      width: 340px;
    }

    .about-content {
      text-align: center;
      padding: 24px;
    }

    .macket-icon {
      width: 64px;
      height: 80px;
      margin: 0 auto 16px;
      border: 2px solid var(--window-border);
      background: var(--window-bg);
      position: relative;
    }

    .macket-screen {
      width: 48px;
      height: 36px;
      border: 2px solid var(--window-border);
      margin: 8px auto 4px;
      background: var(--bg-color);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .macket-screen::before {
      content: ':-)';
      font-size: 10px;
    }

    .macket-base {
      width: 56px;
      height: 8px;
      background: var(--window-bg);
      border-top: 2px solid var(--window-border);
      margin: 0 auto;
    }

    .about-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .about-text {
      font-size: 11px;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .about-divider {
      border: none;
      border-top: 1px solid var(--window-border);
      margin: 12px 0;
    }

    /* Button */
    .macket-button {
      background: var(--window-bg);
      border: 2px solid var(--window-border);
      border-radius: 8px;
      padding: 4px 16px;
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 2px 2px 0 var(--window-border);
      color: var(--text-color);
    }

    .macket-button:active {
      background: var(--text-color);
      color: var(--window-bg);
      box-shadow: none;
      transform: translate(2px, 2px);
    }

    /* Trash Icon */
    .trash-icon {
      width: 28px;
      height: 32px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      position: relative;
    }

    .trash-icon::before {
      content: '';
      position: absolute;
      top: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 4px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
    }

    .trash-icon::after {
      content: '';
      position: absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 18px;
      border-left: 1px solid var(--window-border);
      border-right: 1px solid var(--window-border);
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent 4px,
        var(--window-border) 4px,
        var(--window-border) 5px
      );
    }

    /* Floppy disk icon */
    .floppy-icon {
      width: 30px;
      height: 32px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      position: relative;
    }

    .floppy-icon::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 18px;
      height: 10px;
      background: var(--bg-color);
      border: 1px solid var(--window-border);
    }

    .floppy-icon::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 12px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
    }

    /* HyperCard */
    .hypercard-content {
      padding: 0;
      background: var(--window-bg);
    }

    .hypercard-card {
      padding: 16px;
      min-height: 200px;
      border-bottom: 2px solid var(--window-border);
    }

    .hypercard-title {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 16px;
      text-decoration: underline;
    }

    .hypercard-text {
      font-size: 12px;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .hypercard-button {
      background: var(--window-bg);
      border: 2px solid var(--window-border);
      border-radius: 6px;
      padding: 6px 16px;
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      margin: 4px;
      box-shadow: 1px 1px 0 var(--window-border);
      color: var(--text-color);
    }

    .hypercard-button:active {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .hypercard-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: var(--sidebar-bg);
      border-top: 1px solid var(--window-border);
    }

    .hypercard-nav-btn {
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      padding: 4px 12px;
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      color: var(--text-color);
    }

    .hypercard-nav-btn:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .hypercard-page {
      font-size: 10px;
    }

    /* Git Window */
    .git-wrapper {
      display: flex;
      flex-direction: column;
      height: 350px;
    }

    .git-content {
      padding: 0;
      background: var(--window-bg);
      display: flex;
      flex: 1;
      min-height: 0;
    }

    .git-bottom {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-top: 1px solid var(--window-border);
      background: var(--sidebar-bg);
    }

    .git-commit-input {
      flex: 1;
      padding: 4px 8px;
      font-family: inherit;
      font-size: 11px;
      border: 1px solid var(--window-border);
      background: var(--input-bg);
      color: var(--text-color);
    }

    .git-commit-input:focus {
      outline: none;
    }

    .git-bottom-actions {
      display: flex;
      gap: 6px;
    }

    .git-sidebar {
      width: 200px;
      border-right: 1px solid var(--window-border);
      overflow-y: auto;
      flex-shrink: 0;
    }

    .git-diff-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .git-diff-panel.empty {
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 11px;
    }

    .diff-panel-header {
      padding: 6px 10px;
      border-bottom: 1px solid var(--window-border);
      font-size: 11px;
      font-weight: bold;
      background: var(--sidebar-bg);
      flex-shrink: 0;
    }

    .diff-panel-content {
      flex: 1;
      overflow-y: auto;
      font-family: Monaco, 'Courier New', monospace;
      font-size: 11px;
      background: var(--window-bg);
    }

    .diff-line {
      padding: 1px 8px;
      white-space: pre;
    }

    .diff-line.header {
      background: var(--diff-header-bg);
      color: var(--text-color);
      font-weight: bold;
    }

    .diff-line.added {
      background: var(--diff-added);
      color: var(--diff-added-text);
    }

    .diff-line.removed {
      background: var(--diff-removed);
      color: var(--diff-removed-text);
    }

    .diff-line.context {
      background: var(--window-bg);
      color: var(--text-color);
    }

    .diff-line-number {
      display: inline-block;
      width: 30px;
      text-align: right;
      margin-right: 8px;
      color: var(--text-muted);
      user-select: none;
    }

    .git-section {
      border-bottom: 1px solid var(--window-border);
      padding: 8px;
    }

    .git-section-title {
      font-weight: bold;
      font-size: 11px;
      margin-bottom: 6px;
    }

    .git-branch {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }

    .git-branch-icon {
      font-size: 14px;
    }

    .git-file-list {
      font-size: 11px;
    }

    .git-file-item {
      display: flex;
      align-items: center;
      padding: 3px 4px;
      gap: 6px;
      cursor: pointer;
    }

    .git-file-item:hover {
      background: var(--hover-bg);
    }

    .git-file-item.selected {
      background: var(--selected-bg);
    }

    .git-file-status {
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }

    .git-file-status.modified { color: #b58900; }
    .git-file-status.added { color: #28a745; }
    .git-file-status.deleted { color: #dc3545; }

    .git-file-name {
      flex: 1;
      font-size: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .git-btn {
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      padding: 3px 8px;
      font-family: inherit;
      font-size: 10px;
      cursor: pointer;
      color: var(--text-color);
    }

    .git-btn:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .git-btn-primary {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .git-btn-primary:hover {
      background: var(--hover-bg);
      color: var(--text-color);
    }

    /* Wallpaper Picker */
    .wallpaper-content {
      padding: 12px;
      background: var(--window-bg);
    }

    .wallpaper-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .wallpaper-option {
      width: 100%;
      aspect-ratio: 4/3;
      border: 2px solid var(--window-border);
      cursor: pointer;
      position: relative;
    }

    .wallpaper-option:hover {
      border-color: var(--text-color);
    }

    .wallpaper-option.selected {
      border-color: teal;
      border-width: 3px;
    }

    .wallpaper-option.selected::after {
      content: '✓';
      position: absolute;
      top: 2px;
      right: 4px;
      color: teal;
      font-weight: bold;
    }

    /* Wallpaper patterns */
    .wp-classic {
      background:
        repeating-linear-gradient(0deg, transparent, transparent 1px, var(--bg-color) 1px, var(--bg-color) 2px),
        repeating-linear-gradient(90deg, transparent, transparent 1px, var(--bg-color) 1px, var(--bg-color) 2px);
      background-color: var(--bg-color);
    }

    .wp-solid-gray { background: #808080; }
    .wp-solid-teal { background: #008080; }
    .wp-solid-navy { background: #000080; }
    .wp-gradient-blue { background: linear-gradient(180deg, #87CEEB 0%, #4682B4 100%); }
    .wp-gradient-sunset { background: linear-gradient(180deg, #FF7E5F 0%, #FEB47B 100%); }
    .wp-checkerboard {
      background: repeating-conic-gradient(var(--window-border) 0% 25%, var(--window-bg) 0% 50%) 50% / 20px 20px;
    }
    .wp-diagonal {
      background: repeating-linear-gradient(45deg, var(--bg-color), var(--bg-color) 5px, var(--window-bg) 5px, var(--window-bg) 10px);
    }
    .wp-dots {
      background: radial-gradient(circle, var(--window-border) 1px, transparent 1px);
      background-size: 10px 10px;
      background-color: var(--bg-color);
    }
    .wp-mac-ii {
      background: repeating-conic-gradient(#000 0% 25%, #fff 0% 50%) 50% / 6px 6px;
    }
    .wp-hokusai {
      background: url('assets/hokusai.png') center/cover no-repeat;
    }

    /* UI Alert */
    .ui-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .ui-alert {
      background: var(--window-bg);
      border: 2px solid var(--window-border);
      box-shadow: 2px 2px 0 var(--window-border);
      min-width: 300px;
      max-width: 400px;
    }

    .ui-alert-header {
      background: var(--text-color);
      color: var(--window-bg);
      padding: 4px 8px;
      font-size: 12px;
      font-weight: bold;
    }

    .ui-alert-body {
      padding: 20px;
      text-align: center;
      font-size: 12px;
    }

    .ui-alert-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .ui-alert-buttons {
      padding: 12px;
      display: flex;
      justify-content: center;
      border-top: 1px solid var(--hover-bg);
    }

    .ui-alert-btn {
      background: var(--window-bg);
      border: 2px solid var(--window-border);
      padding: 6px 24px;
      font-family: inherit;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      color: var(--text-color);
    }

    .ui-alert-btn:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    /* Tabbed Window */
    .tabbed-window {
      position: absolute;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      padding: 5px;
      display: flex;
      flex-direction: column;
    }

    .tabbed-window-inner {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--window-bg);
    }

    .tabbed-window-tabs {
      display: flex;
      background: var(--selected-bg);
      border: 2px solid var(--window-border);
      min-height: 24px;
    }

    .tabbed-window-tab {
      padding: 4px 16px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--window-border);
      font-size: 11px;
      cursor: pointer;
      position: relative;
      padding-left: 20px;
    }

    .tabbed-window-tab:hover {
      background: var(--window-bg);
    }

    .tabbed-window-tab.active {
      background: var(--window-bg);
      border-bottom: 2px solid var(--window-bg);
      margin-bottom: -2px;
    }

    .tab-close {
      display: none;
      position: absolute;
      left: 6px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      line-height: 1;
      cursor: pointer;
    }

    .tabbed-window-tab:hover .tab-close {
      display: block;
    }

    .tab-close:hover {
      font-weight: bold;
    }

    .tabbed-window-tab-add {
      padding: 4px 12px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--window-border);
      font-size: 11px;
      cursor: pointer;
    }

    .tabbed-window-tab-add:hover {
      background: var(--window-bg);
    }

    .tabbed-close-box {
      margin: 4px 8px 4px 8px;
      align-self: center;
    }

    .first-tab-with-close {
      border-left: 1px solid var(--window-border);
    }

    .tabbed-window-content {
      flex: 1;
      background: var(--window-bg);
      overflow: hidden;
      display: flex;
      position: relative;
    }

    .tab-pane-container {
      display: none;
      flex: 1;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .tab-pane-container.active {
      display: flex;
    }

    /* Panes */
    .pane {
      flex: 1;
      display: flex;
      background: var(--pane-bg);
      overflow: auto;
      cursor: pointer;
    }

    .pane-multi {
      margin: 2px;
      border: 1px solid var(--window-border);
      position: relative;
      overflow: visible;
    }

    .pane-split-vertical > .pane-multi,
    .pane-split-vertical > .pane-split {
      margin-top: 8px;
    }

    .pane-split-vertical > .pane-multi:first-child,
    .pane-split-vertical > .pane-split:first-child {
      margin-top: 0;
    }

    .tab-pane-container > .pane-split {
      padding-top: 8px;
    }

    .pane-multi.focused {
      border: 2px solid teal;
    }

    .pane-split.parent-highlight {
      background: rgba(0, 128, 128, 0.1);
    }

    .pane-multi.closing-highlight {
      background: rgba(255, 0, 0, 0.2);
    }

    .pane-multi.sibling-highlight {
      background: rgba(0, 128, 128, 0.2);
    }

    .pane-title {
      position: absolute;
      top: -8px;
      left: 8px;
      background: #fff;
      padding: 0 4px;
      font-size: 10px;
      font-weight: bold;
      line-height: 1;
    }

    .pane-content {
      flex: 1;
      padding: 8px;
      overflow: auto;
    }

    .pane-multi .pane-content {
      padding-top: 12px;
    }

    .pane-split {
      flex: 1;
      display: flex;
    }

    .pane-split-vertical {
      flex-direction: column;
    }

    .pane-split-horizontal {
      flex-direction: row;
    }

    /* Upgrade Alert Modal */
    .alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .alert-box {
      background: #fff;
      border: 2px solid #000;
      box-shadow: 4px 4px 0 #000;
      padding: 24px;
      max-width: 320px;
      text-align: center;
    }

    .alert-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 12px;
    }

    .alert-message {
      font-size: 12px;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .alert-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .alert-btn {
      padding: 6px 16px;
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      border: 2px solid #000;
      background: #fff;
    }

    .alert-btn:hover {
      background: #e0e0e0;
    }

    .alert-btn-upgrade {
      background: teal;
      color: #fff;
      border-color: teal;
    }

    .alert-btn-upgrade:hover {
      background: #006666;
    }
  </style>
</head>
<body>
  <!-- Command Palette -->
  <div class="command-palette-overlay" id="command-palette-overlay">
    <div class="command-palette">
      <div class="command-palette-input-wrapper">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.34-4.34"/></svg>
        <input type="text" class="command-palette-input" id="command-palette-input" placeholder="Search commands..." autocomplete="off" spellcheck="false">
      </div>
      <div class="command-palette-results" id="command-palette-results">
        <div class="command-palette-section">
          <div class="command-palette-section-header">Applications</div>
          <div class="command-palette-item" data-action="open-app" data-app="editor">
            <svg class="command-palette-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/></svg>
            <span class="command-palette-item-label">Open Editor</span>
          </div>
          <div class="command-palette-item" data-action="open-app" data-app="stocks">
            <svg class="command-palette-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
            <span class="command-palette-item-label">Open Stocks</span>
          </div>
          <div class="command-palette-item" data-action="open-app" data-app="settings">
            <svg class="command-palette-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            <span class="command-palette-item-label">Open Settings</span>
          </div>
        </div>
        <div class="command-palette-section">
          <div class="command-palette-section-header">Actions</div>
          <div class="command-palette-item" data-action="toggle-chat">
            <svg class="command-palette-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="8" height="18" rx="1"/><rect x="13" y="3" width="8" height="18" rx="1"/></svg>
            <span class="command-palette-item-label">Toggle Chat Panel</span>
            <span class="command-palette-item-shortcut"><kbd>⌘</kbd><kbd>`</kbd></span>
          </div>
          <div class="command-palette-item" data-action="toggle-sidebar">
            <svg class="command-palette-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 3v18"/></svg>
            <span class="command-palette-item-label">Toggle Sidebar</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- App Layout -->
  <div class="app-layout">
    <!-- Left Pane (Sidebar) -->
    <div class="sidebar-container" id="sidebar-container">
      <div class="primary-sidebar" id="primary-sidebar">
        <div class="sidebar-actions" id="search-section">
          <div class="sidebar-item" id="sidebar-toggle-btn">
            <div class="sidebar-item-inner">
              <span class="sidebar-item-icon title-icon">M</span>
              <span class="sidebar-item-label">arketbuffer</span>
            </div>
            <span class="toggle-icon-wrapper" data-tooltip="Toggle Sidebar">
              <svg class="sidebar-item-icon toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 3v18"/></svg>
            </span>
          </div>
          <div class="sidebar-item" id="chat-toggle-btn" data-tooltip="Chat">
            <div class="sidebar-item-inner">
              <svg class="sidebar-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
              <span class="sidebar-item-label">Chat</span>
            </div>
          </div>
          <div class="sidebar-item" id="search-item" data-tooltip="Command">
            <div class="sidebar-item-inner">
              <svg class="sidebar-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#83C18D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
              <span class="sidebar-item-label">Command</span>
            </div>
          </div>
          <div class="sidebar-item" id="apps-btn" data-tooltip="Applications">
            <div class="sidebar-item-inner">
              <svg class="sidebar-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#D2691E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M12 3v18"/><path d="M3 12h18"/></svg>
              <span class="sidebar-item-label">Applications</span>
            </div>
          </div>
          <div class="sidebar-separator"></div>
        </div>
        <div class="sidebar-scrollable" id="sidebar-scrollable">
          <div class="sidebar-section" id="nav-section">
            <div class="sidebar-item" id="lobby-item" data-tooltip="Yap">
              <div class="sidebar-item-inner">
                <svg class="sidebar-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span class="sidebar-item-label">Yap</span>
              </div>
            </div>
            <div class="sidebar-item" id="operate-item" data-tooltip="Deployments">
              <div class="sidebar-item-inner">
                <svg class="sidebar-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>
                <span class="sidebar-item-label">Deployments</span>
              </div>
            </div>
            <div class="sidebar-item" id="data-item" data-tooltip="Data">
              <div class="sidebar-item-inner">
                <svg class="sidebar-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>
                <span class="sidebar-item-label">Data</span>
              </div>
            </div>
            <div class="sidebar-item" id="notifications-item" data-tooltip="Stream">
              <div class="sidebar-item-inner">
                <svg class="sidebar-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="6 3 20 12 6 21 6 3"/></svg>
                <span class="sidebar-item-label">Stream</span>
              </div>
            </div>
            <div class="sidebar-item" id="publish-item" data-tooltip="Publish">
              <div class="sidebar-item-inner">
                <svg class="sidebar-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20"/></svg>
                <span class="sidebar-item-label">Publish</span>
              </div>
            </div>
            <div class="sidebar-item" id="code-item" data-tooltip="Code">
              <div class="sidebar-item-inner">
                <svg class="sidebar-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                <span class="sidebar-item-label">Code</span>
              </div>
            </div>
            <div class="sidebar-item" id="git-item" data-tooltip="Git">
              <div class="sidebar-item-inner">
                <svg class="sidebar-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7"/><path d="M6 9v12"/></svg>
                <span class="sidebar-item-label">Git</span>
              </div>
            </div>
            <div class="sidebar-item" id="simulate-item" data-tooltip="Simulate">
              <div class="sidebar-item-inner">
                <svg class="sidebar-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 7V5a1 1 0 0 0-1-1H6.5a.5.5 0 0 0-.4.8l4.5 6a2 2 0 0 1 0 2.4l-4.5 6a.5.5 0 0 0 .4.8H17a1 1 0 0 0 1-1v-2"/></svg>
                <span class="sidebar-item-label">Simulate</span>
              </div>
            </div>
            <div class="sidebar-item" id="agents-item" data-tooltip="Agents">
              <div class="sidebar-item-inner">
                <svg class="sidebar-item-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                <span class="sidebar-item-label">Agents</span>
              </div>
            </div>
          </div>
          <div class="sidebar-separator"></div>
          <div class="sidebar-section" id="pinned-section">
            <div class="sidebar-section-header">Starred</div>
            <div id="pinned-files">
              <!-- Pinned files rendered by JavaScript -->
            </div>
          </div>
        </div>
        <div class="sidebar-footer" id="sidebar-footer">
          <div class="user-menu" id="user-menu">
            <div class="user-menu-email">foobar@gmail.com</div>
            <div class="user-menu-separator"></div>
            <div class="user-menu-option" data-action="settings"><span class="menu-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></span>Settings</div>
            <div class="user-menu-option has-submenu" data-action="language"><span class="menu-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg></span>Language
              <div class="language-submenu">
                <div class="language-option" data-lang="en-US"><span class="checkmark">&#10003;</span>English (United States)</div>
                <div class="language-option" data-lang="ja"><span class="checkmark"></span>日本語</div>
              </div>
            </div>
            <div class="user-menu-option" data-action="help"><span class="menu-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg></span>Get Help</div>
            <div class="user-menu-separator"></div>
            <div class="user-menu-option" data-action="learn"><span class="menu-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg></span>Learn More</div>
            <div class="user-menu-separator"></div>
            <div class="user-menu-option logout" data-action="logout"><span class="menu-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 17 5-5-5-5"/><path d="M21 12H9"/><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/></svg></span>Logout</div>
          </div>
          <div class="user-menu-btn" id="user-menu-btn">
            <span class="user-avatar">U</span>
            <span class="user-name">User</span>
            <span class="user-chevron"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Pane -->
    <div class="main-pane">
      <!-- Menu Bar -->
      <div class="menu-bar">
        <div class="menu-bar-left">
          <div class="workspace-tabs-container" id="workspace-tabs-container">
            <!-- Workspace tabs rendered dynamically -->
          </div>
          <div class="workspace-add-btn" id="workspace-add-btn" title="Add Workspace">+</div>
        </div>
        <!-- Applications dropdown (positioned by JS) -->
        <div class="menu-dropdown" id="applications-dropdown" style="z-index: 10001;">
          <!-- App list rendered dynamically -->
        </div>
        <!-- App Launcher Drawer -->
        <div class="app-launcher" id="app-launcher">
          <div class="app-launcher-grid" id="app-launcher-grid">
            <!-- App icons rendered dynamically -->
          </div>
          <div class="app-launcher-overflow-indicator left" id="app-launcher-overflow-left">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
          </div>
          <div class="app-launcher-overflow-indicator right" id="app-launcher-overflow-right">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
          </div>
        </div>
      </div>

      <!-- Desktop Area (viewport + prompt) -->
      <div class="desktop-area">
        <div class="desktop" id="desktop">
          <!-- Windows are rendered dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- App Cards -->
  <script src="cards/editor.js"></script>
  <script src="cards/finder.js"></script>
  <script src="cards/about.js"></script>
  <script src="cards/hypercard.js"></script>
  <script src="cards/git.js"></script>
  <script src="cards/settings.js"></script>
  <script src="cards/wallpaper.js"></script>
  <script src="cards/terminal.js"></script>
  <script src="chat-panel.js"></script>
  <script src="cards/changelog.js"></script>
  <script src="cards/neogotchi.js"></script>
  <script src="cards/trinale.js"></script>

  <!-- Server Service (WASM/HTTP abstraction) -->
  <script src="wasm_exec.js"></script>
  <script src="server-service.js"></script>
  <script src="alpaca-provider.js"></script>
  <script src="cards/stocks.js"></script>
  <script src="cards/simulator.js"></script>

  <script>
    // ============================================
    // MARKETBUFFER OS - Using os.js module
    // ============================================

    // Alias for backward compatibility with existing code
    let systemState = null;

    // Load state from OS module
    async function loadSystemState() {
      await OS.loadSystemState();
      systemState = OS.state;
    }

    // Save state via OS module
    function saveSystemState() {
      OS.saveSystemState();
    }

    // Render pinned files (DOM-specific, kept in index.html)
    function renderPinnedFiles() {
      const container = document.getElementById('pinned-files');
      const pinnedFiles = OS.getPinnedFiles();
      if (pinnedFiles.length === 0) {
        container.innerHTML = '<div class="sidebar-item" style="color: #888; font-style: italic;">No pinned files</div>';
        return;
      }

      let html = '';
      pinnedFiles.forEach(path => {
        const name = path.split('/').pop();
        const isStock = path.endsWith('.stock');
        const icon = isStock ? '📈' : '&#128196;';
        html += `
          <div class="pinned-item" data-path="${path}">
            <span class="pinned-item-icon">${icon}</span>
            <span class="pinned-item-name">${name}</span>
            <span class="pinned-item-menu-btn" data-path="${path}">&#8230;</span>
            <div class="pinned-item-menu" data-path="${path}">
              <div class="pinned-item-menu-option" data-action="rename"><span class="menu-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/><path d="m15 5 4 4"/></svg></span>Rename</div>
              <div class="pinned-item-menu-option" data-action="star"><span class="menu-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"/></svg></span>Star</div>
              <div class="pinned-item-menu-separator"></div>
              <div class="pinned-item-menu-option delete" data-action="delete"><span class="menu-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M10 11v6"/><path d="M14 11v6"/></svg></span>Delete</div>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;

      // Attach click listeners
      container.querySelectorAll('.pinned-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.classList.contains('pinned-item-menu-btn')) {
            e.stopPropagation();
            // Close any other open menus
            document.querySelectorAll('.pinned-item-menu.open').forEach(m => m.classList.remove('open'));
            const menu = item.querySelector('.pinned-item-menu');
            menu.classList.toggle('open');
          } else if (e.target.closest('.pinned-item-menu-option')) {
            e.stopPropagation();
            const action = e.target.dataset.action;
            const path = item.dataset.path;
            if (action === 'delete') {
              OS.unpinFile(path);
            }
            // Close menu
            item.querySelector('.pinned-item-menu').classList.remove('open');
          } else if (!e.target.closest('.pinned-item-menu')) {
            OS.openFile(item.dataset.path);
          }
        });
      });
    }

    // Close pinned item menus when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.pinned-item-menu-btn') && !e.target.closest('.pinned-item-menu')) {
        document.querySelectorAll('.pinned-item-menu.open').forEach(m => m.classList.remove('open'));
      }
    });

    // Register FileTree callbacks (systemState available after loadSystemState)
    FileTree.registerCallbacks({
      getSystemState: () => systemState,
      saveSystemState: saveSystemState,
    });

    // Register windows with OS
    OS.registerWindows([
      editorCard,
      finderCard,
      aboutCard,
      hypercardCard,
      gitCard,
      settingsCard,
      wallpaperCard,
      changelogCard,
      neogotchiCard,
      trinaleCard,
      stocksCard,
      simulatorCard,
    ]);

    // Alias for backward compatibility within this file
    const initialWindows = OS.initialWindows;

    // Save windows state to systemState
    function saveState() {
      const state = OS.openWindows.map(win => ({
        id: win.id,
        zIndex: win.zIndex,
        top: win.top,
        left: win.left,
        right: win.right,
        bottom: win.bottom,
        activeTab: win.activeTab,
        tabs: win.tabs ? win.tabs.map(tab => ({
          ...tab,
          panes: tab.panes && editorCard ? editorCard.stripPaneContent(tab.panes) : null
        })) : undefined
      }));
      systemState.windows = state;
      saveSystemState();
    }

    // Load windows state from systemState
    function loadState() {
      // Check if windows array exists (even if empty) - means user has saved state
      if (systemState.windows !== null && systemState.windows !== undefined) {
        try {
          // Merge saved state with initial windows (to get non-serialized properties)
          OS.openWindows = systemState.windows.map(savedWin => {
            const initialWin = OS.getCard(savedWin.id);
            if (initialWin) {
              const merged = { ...initialWin, ...savedWin };
              // Restore pane content for tabbed windows
              if (merged.tabs && editorCard) {
                merged.tabs = merged.tabs.map(tab => ({
                  ...tab,
                  panes: tab.panes ? editorCard.restorePaneContent(tab.panes) : null
                }));
              }
              return merged;
            }
            return null;
          }).filter(Boolean);
          return true;
        } catch (e) {
          console.error('Failed to load state:', e);
        }
      }
      return false;
    }

    // Initialize on page load
    async function init() {
      // Load system state first (fetches version from default-state.json)
      await loadSystemState();

      // Initialize pinned files (after state is loaded so defaults are available)
      OS.loadPinnedFiles();

      // Initialize workspaces (root state initialized later after callbacks are registered)
      OS.initWorkspaces();
      renderWorkspaceTabs();

      // Apply theme, font size, and wallpaper after state is loaded
      loadTheme();
      loadFontSize();
      loadWallpaper();

      // Render pinned files in sidebar
      renderPinnedFiles();

      // Try to load from localStorage, otherwise use initial windows
      if (!loadState()) {
        // Open only default windows, not all
        const defaultWindowIds = systemState.defaultWindows || ['editor', 'about'];
        OS.openWindows = initialWindows
          .filter(win => defaultWindowIds.includes(win.id))
          .map(win => ({ ...win }));
      }
      renderWindows();

      // Inject styles from all cards and call boot() if defined
      initialWindows.forEach(card => {
        if (card.styles) {
          const styleEl = document.createElement('style');
          styleEl.textContent = card.styles;
          document.head.appendChild(styleEl);
        }
        if (typeof card.boot === 'function') {
          card.boot();
        }
      });

      // Set initial active window to the one with highest zIndex
      if (OS.openWindows.length > 0) {
        const topWindow = OS.getTopWindow();
        OS.activeWindowId = topWindow.id;
        updateActiveWindowMenu();
      }

      // Reload file contents for all tabs
      await reloadAllTabFiles();

      // Initialize chat panel (slide-out from right)
      initChatPanel();
    }

    // Reload file contents for all tabs that have a filePath
    async function reloadAllTabFiles() {
      if (typeof editorCard !== 'undefined' && typeof editorCard.reloadAllFiles === 'function') {
        await editorCard.reloadAllFiles();
      }
    }

    // Initialize chat panel
    function initChatPanel() {
      if (typeof ChatPanel === 'undefined') return;
      ChatPanel.init();
    }

    // Render all open windows
    function renderWindows() {
      const desktop = document.getElementById('desktop');
      desktop.innerHTML = '';

      OS.openWindows.forEach((win, index) => {
        const windowEl = document.createElement('div');

        if (win.tabbed) {
          // Tabbed window - delegate rendering to the card
          windowEl.className = 'tabbed-window';
          windowEl.id = 'tabbed-window';
          windowEl.dataset.windowId = win.id;
          OS.applyTabbedWindowStyles(windowEl, win);

          // Find the card and use its render method
          const card = initialWindows.find(c => c.id === win.id);
          if (card && typeof card.render === 'function') {
            windowEl.innerHTML = card.render(win);
          }
        } else {
          // Regular window - positioned relative to desktop container
          windowEl.className = `window ${win.draggable ? 'window-draggable' : ''}`;
          windowEl.dataset.windowId = win.id;
          OS.applyWindowStyles(windowEl, win);

          const closeBoxHtml = OS.getCloseBoxHTML(win);
          const contentHtml = typeof win.content === 'function' ? win.content() : win.content;
          windowEl.innerHTML = OS.createWindowHTML(win, closeBoxHtml, contentHtml);
        }

        desktop.appendChild(windowEl);

        // Call init() after DOM is ready
        if (typeof win.init === 'function') {
          win.init(system);
        }
      });

      attachEventListeners();
      // Setup tabbed window listeners via editorCard
      if (typeof editorCard !== 'undefined' && typeof editorCard.setupEventListeners === 'function') {
        editorCard.setupEventListeners();
        editorCard.initializeEditors();
      }
    }

    // Attach event listeners after rendering
    function attachEventListeners() {
      // Close button handlers (skip tabbed window, handled separately)
      document.querySelectorAll('.window .close-box').forEach(closeBox => {
        closeBox.addEventListener('click', (e) => {
          e.stopPropagation();
          e.stopImmediatePropagation();
          e.preventDefault();
          const windowId = e.target.dataset.windowId;
          closeWindow(windowId);
        }, true);
        closeBox.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          e.stopImmediatePropagation();
          e.preventDefault();
        }, true);
      });

      // Draggable window handlers
      document.querySelectorAll('.window-draggable .window-title-bar').forEach(titleBar => {
        titleBar.addEventListener('mousedown', (e) => {
          if (e.target.closest('.close-box')) return;

          OS.activeWindow = titleBar.closest('.window');
          const rect = OS.activeWindow.getBoundingClientRect();
          OS.dragOffsetX = e.clientX - rect.left;
          OS.dragOffsetY = e.clientY - rect.top;

          // Bring window to front
          bringToFront(OS.activeWindow);
        });
      });

      // Click to bring window to front (all windows, not just draggable)
      document.querySelectorAll('.window').forEach(win => {
        win.addEventListener('mousedown', (e) => {
          if (e.target.closest('.close-box')) return;
          bringToFront(win);
        });

        // Delegate clicks to card's handleClick
        win.addEventListener('click', (e) => {
          const windowId = win.dataset.windowId;
          const card = initialWindows.find(c => c.id === windowId);
          if (card && typeof card.handleClick === 'function') {
            card.handleClick(e);
          }
        });
      });
    }

    // Close a window (only if closeable)
    function closeWindow(windowId) {
      // Check if window exists and is closeable
      const win = OS.getOpenWindow(windowId);
      const initialWin = OS.getCard(windowId);
      const isCloseable = win ? win.closeable : (initialWin ? initialWin.closeable : true);

      if (!isCloseable) return; // Can't close non-closeable windows

      // Remove window element from DOM
      const windowEl = document.querySelector(`.window[data-window-id="${windowId}"], .tabbed-window[data-window-id="${windowId}"]`);
      if (windowEl) {
        windowEl.remove();
      }

      // Remove from openWindows if present
      const wasInArray = OS.isWindowOpen(windowId);
      OS.removeOpenWindow(windowId);

      // Update active window
      if (OS.activeWindowId === windowId || !wasInArray) {
        const topWindow = OS.getTopWindow();
        if (topWindow) {
          OS.activeWindowId = topWindow.id;
        } else {
          OS.activeWindowId = null;
        }
        updateActiveWindowMenu();
      }

      // Update workspace apps
      OS.updateWorkspaceApps();

      saveState();
    }

    // Bring window to front
    function bringToFront(windowEl) {
      const windowId = windowEl.dataset.windowId;
      OS.bringToFront(windowId);
      updateActiveWindowMenu();
      saveState();
    }

    // Bring tabbed window to front
    function bringTabbedToFront() {
      OS.bringTabbedToFront();
      updateActiveWindowMenu();
      saveState();
    }

    // Mouse move handler for dragging
    document.addEventListener('mousemove', (e) => {
      if (!OS.activeWindow) return;

      const desktop = document.getElementById('desktop');
      const desktopRect = desktop.getBoundingClientRect();
      const windowWidth = OS.activeWindow.offsetWidth;
      const windowHeight = OS.activeWindow.offsetHeight;

      // Calculate position relative to desktop
      let top = e.clientY - desktopRect.top - OS.dragOffsetY;
      let right = desktopRect.right - e.clientX - (windowWidth - OS.dragOffsetX);

      // Constrain to desktop bounds (all four edges)
      const maxTop = desktopRect.height - windowHeight;
      const maxRight = desktopRect.width - windowWidth;

      top = Math.max(0, Math.min(top, maxTop));
      right = Math.max(0, Math.min(right, maxRight));

      // Snap to grid if enabled
      if (systemState && systemState.snapToGrid) {
        const gridSize = systemState.gridSize || 50;
        // Show grid overlay while dragging
        OS.showDragGridOverlay(gridSize, OS.activeWindow);
        // Convert right to left for snapping, then back
        const left = desktopRect.width - right - windowWidth;
        const snappedTop = OS.snapToGrid(top, gridSize);
        const snappedLeft = OS.snapToGrid(left, gridSize);
        top = snappedTop;
        right = desktopRect.width - snappedLeft - windowWidth;
        // Re-constrain after snapping
        top = Math.max(0, Math.min(top, maxTop));
        right = Math.max(0, Math.min(right, maxRight));
      }

      OS.activeWindow.style.top = top + 'px';
      OS.activeWindow.style.right = right + 'px';

      // Update position in openWindows array
      const windowId = OS.activeWindow.dataset.windowId;
      const win = OS.getOpenWindow(windowId);
      if (win) {
        win.top = top;
        win.right = right;
      }
    });

    document.addEventListener('mouseup', () => {
      if (OS.activeWindow) {
        // Hide grid overlay and restore z-index
        OS.hideDragGridOverlay();
        OS.activeWindow.style.zIndex = 200;
        saveState();
      }
      OS.activeWindow = null;
    });

    // Initialize
    init();

    // Theme management
    function applyTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
      } else {
        document.body.classList.remove('dark-theme');
      }
      // Update select if it exists
      const themeSelect = document.getElementById('setting-theme');
      if (themeSelect) {
        themeSelect.value = theme;
      }
      // Toggle wb-dark class on all editor elements
      document.querySelectorAll('.playground.wb').forEach(editor => {
        if (theme === 'dark') {
          editor.classList.add('wb-dark');
        } else {
          editor.classList.remove('wb-dark');
        }
      });
    }

    function loadTheme() {
      applyTheme(systemState.theme);
    }

    function saveTheme(theme) {
      systemState.theme = theme;
      saveSystemState();
    }

    // Listen for theme changes (using event delegation since settings may not be open)
    document.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'setting-theme') {
        const theme = e.target.value;
        applyTheme(theme);
        saveTheme(theme);
      }
    });

    // Font size management
    function applyFontSize(size) {
      // Remove all font size classes
      document.body.classList.remove('font-small', 'font-medium', 'font-large');
      // Add the selected one
      document.body.classList.add('font-' + size);
      // Update select if it exists
      const fontSizeSelect = document.getElementById('setting-font-size');
      if (fontSizeSelect) {
        fontSizeSelect.value = size;
      }
    }

    function loadFontSize() {
      applyFontSize(systemState.fontSize);
    }

    function saveFontSize(size) {
      systemState.fontSize = size;
      saveSystemState();
    }

    // Listen for font size changes
    document.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'setting-font-size') {
        const size = e.target.value;
        applyFontSize(size);
        saveFontSize(size);
      }
    });

    // Delegate change events to cards
    document.addEventListener('change', (e) => {
      const windowEl = e.target.closest('[data-window-id]');
      if (windowEl) {
        const windowId = windowEl.dataset.windowId;
        const card = initialWindows.find(c => c.id === windowId);
        if (card && typeof card.handleChange === 'function') {
          card.handleChange(e);
        }
      }
    });

    // Delegate input events to cards (for real-time slider updates)
    document.addEventListener('input', (e) => {
      const windowEl = e.target.closest('[data-window-id]');
      if (windowEl) {
        const windowId = windowEl.dataset.windowId;
        const card = initialWindows.find(c => c.id === windowId);
        if (card && typeof card.handleInput === 'function') {
          card.handleInput(e);
        }
      }
    });

    // Delegate click events to cards
    document.addEventListener('click', (e) => {
      const windowEl = e.target.closest('[data-window-id]');
      if (windowEl) {
        const windowId = windowEl.dataset.windowId;
        const card = initialWindows.find(c => c.id === windowId);
        if (card && typeof card.handleClick === 'function') {
          card.handleClick(e);
        }
      }
    });

    // Delegate mouse events to cards (for tooltips etc)
    document.addEventListener('mouseover', (e) => {
      const windowEl = e.target.closest('[data-window-id]');
      if (windowEl) {
        const windowId = windowEl.dataset.windowId;
        const card = initialWindows.find(c => c.id === windowId);
        if (card && typeof card.handleMouseOver === 'function') {
          card.handleMouseOver(e);
        }
      }
    });

    document.addEventListener('mousemove', (e) => {
      const windowEl = e.target.closest('[data-window-id]');
      if (windowEl) {
        const windowId = windowEl.dataset.windowId;
        const card = initialWindows.find(c => c.id === windowId);
        if (card && typeof card.handleMouseMove === 'function') {
          card.handleMouseMove(e);
        }
      }
    });

    document.addEventListener('mouseout', (e) => {
      const windowEl = e.target.closest('[data-window-id]');
      if (windowEl) {
        const windowId = windowEl.dataset.windowId;
        const card = initialWindows.find(c => c.id === windowId);
        if (card && typeof card.handleMouseOut === 'function') {
          card.handleMouseOut(e);
        }
      }
    });

    document.addEventListener('mouseup', (e) => {
      const windowEl = e.target.closest('[data-window-id]');
      if (windowEl) {
        const windowId = windowEl.dataset.windowId;
        const card = initialWindows.find(c => c.id === windowId);
        if (card && typeof card.handleMouseUp === 'function') {
          card.handleMouseUp(e);
        }
      }
    });

    // Wallpaper management
    const wallpaperClasses = ['wp-classic', 'wp-solid-gray', 'wp-solid-teal', 'wp-solid-navy', 'wp-gradient-blue', 'wp-gradient-sunset', 'wp-checkerboard', 'wp-diagonal', 'wp-dots', 'wp-mac-ii', 'wp-hokusai'];

    function applyWallpaper(wallpaper) {
      const desktop = document.getElementById('desktop');
      if (!desktop) return;

      // Remove all wallpaper classes
      wallpaperClasses.forEach(cls => desktop.classList.remove(cls));
      // Add the selected one
      desktop.classList.add('wp-' + wallpaper);

      // Update selection UI if wallpaper picker is open
      document.querySelectorAll('.wallpaper-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.wallpaper === wallpaper) {
          opt.classList.add('selected');
        }
      });
    }

    function loadWallpaper() {
      applyWallpaper(systemState.wallpaper);
    }

    function saveWallpaper(wallpaper) {
      systemState.wallpaper = wallpaper;
      saveSystemState();
    }

    // Listen for wallpaper clicks (using event delegation)
    document.addEventListener('click', (e) => {
      const wallpaperOption = e.target.closest('.wallpaper-option');
      if (wallpaperOption && wallpaperOption.dataset.wallpaper) {
        const wallpaper = wallpaperOption.dataset.wallpaper;
        applyWallpaper(wallpaper);
        saveWallpaper(wallpaper);
      }
    });


    // Show upgrade alert when pane limit is reached
    function showUpgradeAlert() {
      const overlay = document.createElement('div');
      overlay.className = 'alert-overlay';
      overlay.innerHTML = `
        <div class="alert-box">
          <div class="alert-title">Pane Limit Reached</div>
          <div class="alert-message">
            You cannot open more than 8 panes per tab on the free plan.
            Upgrade to Pro for unlimited panes and advanced features.
          </div>
          <div class="alert-buttons">
            <button class="alert-btn" id="alert-cancel">Cancel</button>
            <button class="alert-btn alert-btn-upgrade" id="alert-upgrade">Upgrade</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);

      document.getElementById('alert-cancel').addEventListener('click', () => {
        overlay.remove();
      });

      document.getElementById('alert-upgrade').addEventListener('click', () => {
        // Handle upgrade action
        overlay.remove();
      });

      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
        }
      });
    }

    // Active window menu (legacy - kept for compatibility)
    function updateActiveWindowMenu() {
      // Now handled by workspace tabs
    }

    // Workspace tabs
    function renderWorkspaceTabs() {
      const container = document.getElementById('workspace-tabs-container');
      const addBtn = document.getElementById('workspace-add-btn');
      const menuBar = document.querySelector('.menu-bar');
      container.innerHTML = '';

      // Hide tabs, + button, and menu bar for non-tabular root states
      if (!OS.isTabular()) {
        container.style.display = 'none';
        if (addBtn) addBtn.style.display = 'none';
        if (menuBar) menuBar.style.display = 'none';
        return;
      }
      container.style.display = 'flex';
      if (menuBar) menuBar.style.display = '';

      OS.workspaces.forEach((workspace, index) => {
        // Add separator before tabs (except first)
        if (index > 0) {
          const prevWorkspace = OS.workspaces[index - 1];
          const separator = document.createElement('span');
          separator.className = 'workspace-tab-separator';
          separator.textContent = '|';
          // Hide separator if either adjacent tab is active
          if (workspace.id === OS.activeWorkspaceId || prevWorkspace.id === OS.activeWorkspaceId) {
            separator.style.visibility = 'hidden';
          }
          container.appendChild(separator);
        }

        const tab = document.createElement('div');
        tab.className = 'workspace-tab' + (workspace.id === OS.activeWorkspaceId ? ' active' : '');
        tab.dataset.workspaceId = workspace.id;

        // Only show close button if there's more than one workspace
        const closeBtn = OS.workspaces.length > 1
          ? `<span class="workspace-tab-close" data-workspace-id="${workspace.id}">&times;</span>`
          : '';
        tab.innerHTML = `<span class="workspace-tab-name">${workspace.name}</span>${closeBtn}`;

        tab.addEventListener('click', (e) => {
          // Don't switch if clicking the close button
          if (e.target.classList.contains('workspace-tab-close')) {
            e.stopPropagation();
            OS.deleteWorkspace(workspace.id);
            return;
          }
          OS.switchToWorkspace(workspace.id);
        });

        container.appendChild(tab);
      });

      // Add trailing separator before the + button
      const lastWorkspace = OS.workspaces[OS.workspaces.length - 1];
      if (OS.workspaces.length < 4) {
        const separator = document.createElement('span');
        separator.className = 'workspace-tab-separator';
        separator.textContent = '|';
        // Hide if last tab is active
        if (lastWorkspace && lastWorkspace.id === OS.activeWorkspaceId) {
          separator.style.visibility = 'hidden';
        }
        container.appendChild(separator);
      }

      // Hide/show the + button based on workspace count
      if (addBtn) {
        addBtn.style.display = OS.workspaces.length >= 4 ? 'none' : 'flex';
      }
    }

    function switchWorkspace(workspace) {
      // Close all current windows (remove from DOM)
      document.querySelectorAll('.window').forEach(w => w.remove());
      const tabbedWindow = document.getElementById('tabbed-window');
      if (tabbedWindow) tabbedWindow.remove();

      // Clear open windows
      OS.openWindows = [];

      // Restore windows with saved state (positions, tabs, etc.)
      if (workspace.windowState && workspace.windowState.length > 0) {
        workspace.windowState.forEach(savedWin => {
          const card = OS.getCard(savedWin.id);
          if (card) {
            // Merge card defaults with saved state
            const restoredWin = { ...card, ...savedWin };
            // Restore pane content for tabbed windows
            if (restoredWin.tabs && editorCard) {
              restoredWin.tabs = restoredWin.tabs.map(tab => ({
                ...tab,
                panes: tab.panes ? editorCard.restorePaneContent(tab.panes) : null,
              }));
            }
            OS.addOpenWindow(restoredWin);
            renderSingleWindow(restoredWin);
          }
        });
      } else if (workspace.openApps && workspace.openApps.length > 0) {
        // Fallback for old workspaces that only have app IDs
        workspace.openApps.forEach(appId => {
          const card = OS.getCard(appId);
          if (card) {
            openApplication(appId);
          }
        });
      }

      // Update active window
      if (OS.openWindows.length > 0) {
        const topWindow = OS.getTopWindow();
        OS.activeWindowId = topWindow.id;
      } else {
        OS.activeWindowId = null;
      }
    }

    function renderActiveWindowDropdown() {
      const dropdown = document.getElementById('active-window-dropdown');
      dropdown.innerHTML = '';

      const win = OS.getOpenWindow(OS.activeWindowId);
      if (!win || !win.contextMenu) return;

      win.contextMenu.forEach(item => {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-dropdown-item';
        menuItem.textContent = item.label;
        menuItem.addEventListener('click', (e) => {
          e.stopPropagation();
          highlightParentSplit(false);
          executeContextMenuAction(win.id, item.action);
          closeActiveWindowMenu();
        });

        // Add hover highlight for close-pane
        if (item.action === 'close-pane') {
          menuItem.addEventListener('mouseenter', () => {
            highlightParentSplit(true);
          });
          menuItem.addEventListener('mouseleave', () => {
            highlightParentSplit(false);
          });
        }

        dropdown.appendChild(menuItem);
      });
    }

    function executeContextMenuAction(windowId, action) {
      // Find the card and delegate action
      const card = initialWindows.find(c => c.id === windowId);
      if (card && typeof card.executeAction === 'function') {
        card.executeAction(action);
      } else if (action === 'close') {
        OS.close(windowId);
      }
    }

    function highlightParentSplit(show) {
      // Delegate to editorCard
      if (typeof editorCard !== 'undefined' && typeof editorCard.highlightParentSplit === 'function') {
        editorCard.highlightParentSplit(show);
      }
    }

    function toggleActiveWindowMenu() {
      const dropdown = document.getElementById('active-window-dropdown');
      const isOpen = dropdown.classList.contains('open');
      if (isOpen) {
        closeActiveWindowMenu();
      } else {
        renderActiveWindowDropdown();
        dropdown.classList.add('open');
      }
    }

    function closeActiveWindowMenu() {
      const dropdown = document.getElementById('active-window-dropdown');
      if (dropdown) {
        dropdown.classList.remove('open');
      }
      highlightParentSplit(false);
    }

    // Register app launcher callbacks
    AppLauncher.registerCallbacks({
      getWindows: () => initialWindows,
      isWindowOpen: (id) => OS.isWindowOpen(id),
      openApplication: openApplication,
    });

    function openApplication(windowId) {
      if (OS.isWindowOpen(windowId)) {
        // Window already open - bring to front
        const windowEl = document.querySelector(`[data-window-id="${windowId}"]`);
        if (windowEl) {
          bringToFront(windowEl);
        }
      } else {
        const win = OS.getCard(windowId);
        if (win) {
          // Clean up any stale DOM element with the same ID
          const existingEl = document.querySelector(`[data-window-id="${windowId}"]`);
          if (existingEl) existingEl.remove();

          // Reset all z-indexes in data and DOM
          OS.openWindows.forEach(w => {
            w.zIndex = w.tabbed ? 50 : 100;
            const el = document.querySelector(`[data-window-id="${w.id}"]`);
            if (el) el.style.zIndex = w.zIndex;
          });
          // Add new window with highest z-index
          const newWin = { ...win, zIndex: 200 };

          // Ensure tabbed windows have at least one tab
          if (newWin.tabbed && (!newWin.tabs || newWin.tabs.length === 0)) {
            // Find the card and let it initialize its default state
            const card = OS.getCard(newWin.id);
            if (card && typeof card.initDefaultTab === 'function') {
              card.initDefaultTab(newWin);
            }
          }

          OS.addOpenWindow(newWin);
          // Set as active window
          OS.activeWindowId = windowId;
          // Update workspace apps
          OS.updateWorkspaceApps();
          saveState();
          // Render just the new window (DOM manipulation)
          renderSingleWindow(newWin);
          updateActiveWindowMenu();
        }
      }
    }

    // Get serialized window state for workspace saving
    function getWindowState() {
      return OS.openWindows.map(win => ({
        id: win.id,
        zIndex: win.zIndex,
        top: win.top,
        left: win.left,
        right: win.right,
        bottom: win.bottom,
        width: win.width,
        height: win.height,
        activeTab: win.activeTab,
        tabs: win.tabs ? win.tabs.map(tab => ({
          ...tab,
          panes: tab.panes && editorCard ? editorCard.stripPaneContent(tab.panes) : null,
        })) : undefined,
      }));
    }

    // Register OS callbacks now that functions are defined
    OS.registerCallbacks({
      closeWindow: closeWindow,
      openApplication: openApplication,
      renderPinnedFiles: renderPinnedFiles,
      renderWorkspaceTabs: renderWorkspaceTabs,
      switchWorkspace: switchWorkspace,
      getWindowState: getWindowState,
    });

    function renderSingleWindow(win) {
      const desktop = document.getElementById('desktop');
      const windowEl = document.createElement('div');

      if (win.tabbed) {
        // Tabbed window - delegate rendering to the card
        windowEl.className = 'tabbed-window';
        windowEl.id = 'tabbed-window';
        windowEl.dataset.windowId = win.id;
        OS.applyTabbedWindowStyles(windowEl, win);

        // Find the card and use its render method
        const card = initialWindows.find(c => c.id === win.id);
        if (card && typeof card.render === 'function') {
          windowEl.innerHTML = card.render(win);
        }

        desktop.appendChild(windowEl);

        // Setup tabbed window listeners via editorCard
        if (typeof editorCard !== 'undefined' && typeof editorCard.setupEventListeners === 'function') {
          editorCard.setupEventListeners();
          editorCard.initializeEditors();
        }
      } else {
        // Regular window
        windowEl.className = `window ${win.draggable ? 'window-draggable' : ''}`;
        windowEl.dataset.windowId = win.id;
        OS.applyWindowStyles(windowEl, win);

        const closeBoxHtml = OS.getCloseBoxHTML(win);

        // Call init() on win before rendering content so it can set up state
        if (typeof win.init === 'function') {
          win.init(system);
        }

        const contentHtml = typeof win.content === 'function' ? win.content() : win.content;
        windowEl.innerHTML = OS.createWindowHTML(win, closeBoxHtml, contentHtml);

        desktop.appendChild(windowEl);
        attachWindowEventListeners(windowEl, win);
      }
    }

    function attachWindowEventListeners(windowEl, win) {
      // Close box
      const closeBox = windowEl.querySelector('.close-box');
      if (closeBox) {
        closeBox.addEventListener('click', (e) => {
          e.stopPropagation();
          e.stopImmediatePropagation();
          e.preventDefault();
          closeWindow(win.id);
        }, true);
        closeBox.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          e.stopImmediatePropagation();
          e.preventDefault();
        }, true);
      }

      // Dragging
      if (win.draggable) {
        const titleBar = windowEl.querySelector('.window-title-bar');
        if (titleBar) {
          titleBar.addEventListener('mousedown', (e) => {
            if (e.target.closest('.close-box')) return;
            OS.activeWindow = windowEl;
            const rect = windowEl.getBoundingClientRect();
            OS.dragOffsetX = e.clientX - rect.left;
            OS.dragOffsetY = e.clientY - rect.top;
            bringToFront(windowEl);
          });
        }
      }

      // Bring to front on click
      windowEl.addEventListener('mousedown', (e) => {
        if (e.target.closest('.close-box')) return;
        bringToFront(windowEl);
      });

      // Delegate clicks to card's handleClick
      windowEl.addEventListener('click', (e) => {
        const card = OS.getCard(win.id);
        if (card && typeof card.handleClick === 'function') {
          card.handleClick(e);
        }
      });

      // Re-attach git file handlers if this is the git window
      if (win.id === 'git' && typeof gitCard !== 'undefined') {
        gitCard.init();
      }

      // Sync settings selects if this is the settings window
      if (win.id === 'settings') {
        const themeSelect = document.getElementById('setting-theme');
        if (themeSelect) {
          themeSelect.value = systemState.theme;
        }
        const fontSizeSelect = document.getElementById('setting-font-size');
        if (fontSizeSelect) {
          fontSizeSelect.value = systemState.fontSize;
        }
      }

      // Sync wallpaper selection if this is the wallpaper window
      if (win.id === 'wallpaper') {
        document.querySelectorAll('.wallpaper-option').forEach(opt => {
          opt.classList.remove('selected');
          if (opt.dataset.wallpaper === systemState.wallpaper) {
            opt.classList.add('selected');
          }
        });
      }
    }

    function toggleApplicationsMenu() {
      AppLauncher.toggle();
    }

    function closeApplicationsMenu() {
      AppLauncher.close();
    }

    // User menu
    document.getElementById('user-menu-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      const menu = document.getElementById('user-menu');
      menu.classList.toggle('open');
    });

    document.getElementById('user-menu').addEventListener('click', (e) => {
      const option = e.target.closest('.user-menu-option');
      if (!option) return;

      const action = option.dataset.action;
      document.getElementById('user-menu').classList.remove('open');

      if (action === 'settings') {
        openApplication('settings');
      } else if (action === 'logout') {
        // Handle logout
      }
    });

    // Close user menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#sidebar-footer') && !e.target.closest('#user-menu')) {
        document.getElementById('user-menu').classList.remove('open');
      }
    });

    // Command Palette
    const commandPalette = {
      overlay: document.getElementById('command-palette-overlay'),
      input: document.getElementById('command-palette-input'),

      open() {
        this.overlay.classList.add('open');
        this.input.value = '';
        this.input.focus();
      },

      close() {
        this.overlay.classList.remove('open');
      },

      toggle() {
        if (this.overlay.classList.contains('open')) {
          this.close();
        } else {
          this.open();
        }
      },

      executeAction(action, data) {
        this.close();
        if (action === 'open-app') {
          openApplication(data.app);
        } else if (action === 'toggle-chat') {
          ChatPanel.toggle();
        } else if (action === 'toggle-sidebar') {
          document.getElementById('sidebar-container').classList.toggle('collapsed');
        }
      },
    };

    // Search item click opens command palette
    document.getElementById('search-item').addEventListener('click', () => {
      commandPalette.open();
    });

    // Keyboard shortcut: Cmd+K or Ctrl+K
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        commandPalette.toggle();
      }
      // Escape to close
      if (e.key === 'Escape' && commandPalette.overlay.classList.contains('open')) {
        commandPalette.close();
      }
    });

    // Click outside to close
    commandPalette.overlay.addEventListener('click', (e) => {
      if (e.target === commandPalette.overlay) {
        commandPalette.close();
      }
    });

    // Handle command palette item clicks
    document.getElementById('command-palette-results').addEventListener('click', (e) => {
      const item = e.target.closest('.command-palette-item');
      if (item) {
        const action = item.dataset.action;
        const app = item.dataset.app;
        commandPalette.executeAction(action, { app });
      }
    });

    // Add workspace button
    document.getElementById('workspace-add-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      const workspace = OS.createWorkspace();
      OS.switchToWorkspace(workspace.id);
    });

    // Root state nav buttons
    const rootStateMap = {
      'lobby-item': 'yap',
      'operate-item': 'operate',
      'deploy-item': 'deploy',
      'data-item': 'data',
      'notifications-item': 'feed',
      'publish-item': 'author',
      'code-item': 'code',
      'git-item': 'git',
      'simulate-item': 'simulate',
      'agents-item': 'agents',
    };

    Object.entries(rootStateMap).forEach(([elementId, stateName]) => {
      const el = document.getElementById(elementId);
      if (el) {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          OS.setRootState(stateName);
        });
      }
    });

    // Callback for root state changes
    function onRootStateChange(stateName) {
      // Update active state in sidebar
      Object.keys(rootStateMap).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('active');
      });
      const activeId = Object.entries(rootStateMap).find(([, s]) => s === stateName)?.[0];
      if (activeId) {
        document.getElementById(activeId)?.classList.add('active');
      }

      // Show active state on title when on home/work state
      const toggleBtn = document.getElementById('sidebar-toggle-btn');
      const appsBtn = document.getElementById('apps-btn');
      if (stateName === 'work') {
        toggleBtn?.classList.add('home-active');
        appsBtn?.classList.remove('disabled');
      } else {
        toggleBtn?.classList.remove('home-active');
        appsBtn?.classList.add('disabled');
      }

      // Re-render workspace tabs (will hide/show based on tabular state)
      renderWorkspaceTabs();

      // Show/hide windows based on root state
      const desktop = document.getElementById('desktop');
      const tabbedWindow = document.getElementById('tabbed-window');
      let modalityContainer = document.getElementById('modality-container');

      if (stateName === 'work') {
        // Show all windows
        desktop.querySelectorAll('.window').forEach(w => w.style.display = '');
        if (tabbedWindow) tabbedWindow.style.display = '';
        // Hide modality container
        if (modalityContainer) modalityContainer.style.display = 'none';
        // Restore wallpaper
        desktop.style.background = '';
      } else {
        // Hide all windows for non-work states
        desktop.querySelectorAll('.window').forEach(w => w.style.display = 'none');
        if (tabbedWindow) tabbedWindow.style.display = 'none';
        // Set neutral background
        const isDark = document.body.classList.contains('dark-theme');
        desktop.style.background = isDark ? '#2a2a2a' : '#d0d0d0';
        // Load modality content
        loadModality(stateName);
      }
    }

    // Load modality HTML content
    async function loadModality(stateName) {
      const desktop = document.getElementById('desktop');
      let modalityContainer = document.getElementById('modality-container');

      // Create container if it doesn't exist
      if (!modalityContainer) {
        modalityContainer = document.createElement('div');
        modalityContainer.id = 'modality-container';
        modalityContainer.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow: hidden;';
        desktop.appendChild(modalityContainer);
      }

      // Show container
      modalityContainer.style.display = 'block';

      // Load the modality HTML
      try {
        const response = await fetch(`modality/${stateName}.html`);
        if (response.ok) {
          const html = await response.text();
          modalityContainer.innerHTML = html;
          // Execute any scripts in the loaded HTML
          modalityContainer.querySelectorAll('script').forEach(oldScript => {
            const newScript = document.createElement('script');
            newScript.textContent = oldScript.textContent;
            oldScript.parentNode.replaceChild(newScript, oldScript);
          });
        } else {
          modalityContainer.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">${stateName} view coming soon</div>`;
        }
      } catch (e) {
        modalityContainer.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">${stateName} view coming soon</div>`;
      }
    }

    OS.registerCallbacks({
      onRootStateChange: onRootStateChange,
    });

    // Initialize root state from saved state and apply UI
    OS.initRootState();
    onRootStateChange(OS.activeRootState);



    // Sidebar action buttons
    document.getElementById('sidebar-toggle-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      // If clicking the icon, toggle sidebar; otherwise go home
      if (e.target.closest('.toggle-icon-wrapper')) {
        const sidebar = document.getElementById('sidebar-container');
        sidebar.classList.add('animating');
        sidebar.classList.toggle('collapsed');
        setTimeout(() => sidebar.classList.remove('animating'), 300);
      } else {
        OS.setRootState('work');
      }
    });

    document.getElementById('chat-toggle-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      ChatPanel.toggle();
    });

    document.getElementById('apps-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      closeActiveWindowMenu();
      closeApplicationsMenu();
      toggleApplicationsDropdown('sidebar');
    });

    function toggleApplicationsDropdown(source) {
      const dropdown = document.getElementById('applications-dropdown');
      if (dropdown.classList.contains('open')) {
        closeApplicationsDropdown();
      } else {
        renderApplicationsDropdown();
        dropdown.classList.add('open');

        // Position next to sidebar
        const sidebar = document.getElementById('sidebar-container');
        const appsBtn = document.getElementById('apps-btn');
        const sidebarRect = sidebar.getBoundingClientRect();
        const btnRect = appsBtn.getBoundingClientRect();
        dropdown.style.position = 'fixed';
        dropdown.style.top = btnRect.top + 'px';
        dropdown.style.left = sidebarRect.right + 'px';
      }
    }

    function closeApplicationsDropdown() {
      const dropdown = document.getElementById('applications-dropdown');
      if (dropdown) {
        dropdown.classList.remove('open');
      }
    }

    function renderApplicationsDropdown() {
      const dropdown = document.getElementById('applications-dropdown');
      dropdown.innerHTML = '';
      initialWindows.forEach(win => {
        const item = document.createElement('div');
        item.className = 'menu-dropdown-item';
        if (OS.isWindowOpen(win.id)) {
          item.classList.add('checked');
        }
        item.textContent = win.title;
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          openApplication(win.id);
          closeApplicationsDropdown();
        });
        dropdown.appendChild(item);
      });
    }

    document.addEventListener('click', (e) => {
      closeApplicationsMenu();
      closeApplicationsDropdown();
      closeActiveWindowMenu();
      // Close chat panel if clicking outside of it (but not while resizing)
      if (typeof ChatPanel !== 'undefined' && ChatPanel.isExpanded && !ChatPanel.isResizing) {
        const chatPanel = document.getElementById('chat-panel');
        const chatBtn = document.getElementById('chat-toggle-btn');
        if (chatPanel && !chatPanel.contains(e.target) && !chatBtn.contains(e.target)) {
          ChatPanel.collapse();
        }
      }
    });

    // Global close box handler - handles close on mousedown before anything else
    document.addEventListener('mousedown', (e) => {
      const closeBox = e.target.closest('.close-box');
      if (closeBox) {
        e.stopPropagation();
        e.stopImmediatePropagation();
        e.preventDefault();
        const windowId = closeBox.dataset.windowId;
        if (windowId) {
          closeWindow(windowId);
        }
      }
    }, true);

    // OS Alert dialog
    function showUIAlert(title, message) {
      const overlay = document.createElement('div');
      overlay.className = 'ui-alert-overlay';
      overlay.innerHTML = `
        <div class="ui-alert">
          <div class="ui-alert-header">${title}</div>
          <div class="ui-alert-body">
            <div class="ui-alert-icon">&#9888;</div>
            <div>${message}</div>
          </div>
          <div class="ui-alert-buttons">
            <button class="ui-alert-btn">OK</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);

      const closeAlert = () => overlay.remove();
      overlay.querySelector('.ui-alert-btn').onclick = closeAlert;
      overlay.onclick = (e) => { if (e.target === overlay) closeAlert(); };
    }
  </script>
</body>
</html>
