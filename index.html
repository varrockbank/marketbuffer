<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketbuffer</title>
  <script src="vendor/buffer.js"></script>
  <link rel="stylesheet" href="vendor/buffer.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Chicago&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-color: #a8a8a8;
      --window-bg: #fff;
      --window-border: #000;
      --title-bar-bg: #c0c0c0;
      --text-color: #000;
      --text-muted: #666;
      --menu-bg: #fff;
      --menu-border: #000;
      --sidebar-bg: #e8e8e8;
      --input-bg: #fff;
      --input-border: #000;
      --hover-bg: #e0e0e0;
      --selected-bg: #c0c0c0;
      --pane-bg: #fff;
      --diff-added: #d4edda;
      --diff-removed: #f8d7da;
      --diff-added-text: #155724;
      --diff-removed-text: #721c24;
      --diff-header-bg: #e8e8fc;
    }

    body.dark-theme {
      --bg-color: #1e1e1e;
      --window-bg: #2d2d2d;
      --window-border: #555;
      --title-bar-bg: #3c3c3c;
      --text-color: #e0e0e0;
      --text-muted: #888;
      --menu-bg: #2d2d2d;
      --menu-border: #555;
      --sidebar-bg: #252525;
      --input-bg: #3c3c3c;
      --input-border: #555;
      --hover-bg: #404040;
      --selected-bg: #505050;
      --pane-bg: #1e1e1e;
      --diff-added: #2d4a3e;
      --diff-removed: #4a2d2d;
      --diff-added-text: #8fdf8f;
      --diff-removed-text: #df8f8f;
      --diff-header-bg: #3c3c5c;
    }

    body {
      font-family: 'Chicago', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      background: var(--bg-color);
      min-height: 100vh;
      cursor: default;
      color: var(--text-color);
      user-select: none;
    }

    /* Font size classes - affects sidebar and menu only */
    body.font-small .menu-bar,
    body.font-small .primary-sidebar,
    body.font-small .sidebar-section-header,
    body.font-small .sidebar-item,
    body.font-small .sidebar-footer,
    body.font-small .tree-item-row { font-size: 10px; }
    body.font-medium .menu-bar,
    body.font-medium .primary-sidebar,
    body.font-medium .sidebar-section-header,
    body.font-medium .sidebar-item,
    body.font-medium .sidebar-footer,
    body.font-medium .tree-item-row { font-size: 12px; }
    body.font-large .menu-bar,
    body.font-large .primary-sidebar,
    body.font-large .sidebar-section-header,
    body.font-large .sidebar-item,
    body.font-large .sidebar-footer,
    body.font-large .tree-item-row { font-size: 14px; }

    /* Menu Bar */
    .menu-bar {
      background: var(--menu-bg);
      border-bottom: 2px solid var(--menu-border);
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .menu-bar-left {
      display: flex;
      align-items: center;
    }

    .menu-bar-right {
      display: flex;
      align-items: center;
    }

    .menu-item {
      padding: 2px 12px;
      cursor: pointer;
    }

    .menu-item-bold {
      font-weight: bold;
    }

    .menu-item:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .menu-item-container {
      position: relative;
    }

    .menu-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--menu-bg);
      border: 1px solid var(--menu-border);
      box-shadow: 2px 2px 0 var(--menu-border);
      min-width: 180px;
      z-index: 1001;
    }

    .menu-dropdown.open {
      display: block;
    }

    .menu-dropdown-item {
      padding: 4px 12px 4px 24px;
      cursor: pointer;
      position: relative;
      white-space: nowrap;
    }

    .menu-dropdown-item:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .menu-dropdown-item.checked::before {
      content: '✓';
      position: absolute;
      left: 8px;
    }

    .menu-dropdown-separator {
      height: 1px;
      background: var(--window-border);
      margin: 4px 0;
    }

    /* Primary Sidebar */
    .primary-sidebar {
      width: 200px;
      background: var(--window-bg);
      border-right: 2px solid var(--window-border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-section {
      border-bottom: 1px solid var(--window-border);
    }

    .sidebar-section-header {
      padding: 8px 12px;
      font-weight: bold;
      font-size: 11px;
      background: var(--sidebar-bg);
      border-bottom: 1px solid var(--window-border);
    }

    .sidebar-item {
      padding: 6px 12px 6px 24px;
      font-size: 11px;
      cursor: pointer;
      position: relative;
    }

    .sidebar-item:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .sidebar-item.active {
      background: var(--selected-bg);
    }

    .sidebar-item-icon {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
    }

    .sidebar-spacer {
      flex: 1;
    }

    /* File Tree */
    .file-tree {
      flex: 1;
      overflow-y: auto;
      padding: 4px 0;
    }

    .tree-item {
      cursor: pointer;
      white-space: nowrap;
    }

    .tree-item-row {
      display: flex;
      align-items: center;
      padding: 3px 8px;
      font-size: 11px;
    }

    .tree-item-row:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .tree-item-row.selected {
      background: var(--selected-bg);
    }

    .tree-toggle {
      width: 12px;
      height: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      flex-shrink: 0;
      margin-right: 2px;
    }

    .tree-icon {
      width: 14px;
      height: 14px;
      margin-right: 4px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .tree-label {
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .tree-pin {
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      opacity: 0;
      cursor: pointer;
      margin-left: auto;
    }

    .tree-item-row:hover .tree-pin {
      opacity: 0.5;
    }

    .tree-pin:hover {
      opacity: 1 !important;
    }

    .tree-pin.pinned {
      opacity: 1;
    }

    .pinned-item {
      display: flex;
      align-items: center;
      padding: 3px 8px;
      font-size: 11px;
      cursor: pointer;
    }

    .pinned-item:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .pinned-item-icon {
      margin-right: 4px;
      font-size: 10px;
    }

    .pinned-item-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pinned-item-unpin {
      opacity: 0;
      cursor: pointer;
      font-size: 10px;
    }

    .pinned-item:hover .pinned-item-unpin {
      opacity: 0.5;
    }

    .pinned-item-unpin:hover {
      opacity: 1 !important;
    }

    .tree-children {
      display: none;
    }

    .tree-children.expanded {
      display: block;
    }

    .tree-item[data-depth="0"] > .tree-item-row { padding-left: 8px; }
    .tree-item[data-depth="1"] > .tree-item-row { padding-left: 22px; }
    .tree-item[data-depth="2"] > .tree-item-row { padding-left: 36px; }
    .tree-item[data-depth="3"] > .tree-item-row { padding-left: 50px; }
    .tree-item[data-depth="4"] > .tree-item-row { padding-left: 64px; }

    .sidebar-footer {
      padding: 8px 12px;
      font-size: 10px;
      color: var(--text-muted);
      border-top: 1px solid var(--window-border);
      background: var(--sidebar-bg);
    }

    /* Main Layout Container */
    .main-layout {
      display: flex;
      position: fixed;
      top: 20px;
      left: 0;
      right: 0;
      bottom: 0;
    }

    /* Desktop */
    .desktop {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    /* Desktop Icons */
    .desktop-icons {
      position: absolute;
      top: 30px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .desktop-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 64px;
      cursor: pointer;
    }

    .desktop-icon:hover .icon-label {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .icon-image {
      width: 32px;
      height: 32px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 4px;
    }

    .icon-label {
      font-size: 10px;
      text-align: center;
      padding: 1px 3px;
    }

    /* Window */
    .window {
      position: absolute;
      background: var(--window-bg);
      border: 2px solid var(--window-border);
      box-shadow: 2px 2px 0 var(--window-border);
      min-width: 300px;
      left: auto;
    }

    .window-title-bar {
      background: var(--title-bar-bg);
      border-bottom: 2px solid var(--window-border);
      padding: 2px 4px;
      display: flex;
      align-items: center;
      height: 20px;
    }

    .window-draggable .window-title-bar {
      cursor: move;
    }

    .window-title-bar::before,
    .window-title-bar::after {
      content: '';
      flex: 1;
      height: 10px;
      background: repeating-linear-gradient(
        0deg,
        var(--window-border),
        var(--window-border) 1px,
        var(--title-bar-bg) 1px,
        var(--title-bar-bg) 3px
      );
    }

    .window-title {
      padding: 0 8px;
      font-weight: bold;
      font-size: 12px;
      white-space: nowrap;
    }

    .close-box {
      width: 12px;
      height: 12px;
      border: 1px solid var(--window-border);
      background: var(--window-bg);
      margin-right: 4px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .close-box:hover {
      background: var(--text-color);
    }

    .window-content {
      padding: 16px;
      background: var(--window-bg);
    }

    /* Scrollbar styling for window */
    .window-scrollable {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--window-border);
      margin: 8px;
      background: var(--window-bg);
    }

    .window-scrollable::-webkit-scrollbar {
      width: 16px;
    }

    .window-scrollable::-webkit-scrollbar-track {
      background:
        repeating-linear-gradient(
          45deg,
          var(--window-bg),
          var(--window-bg) 2px,
          var(--bg-color) 2px,
          var(--bg-color) 4px
        );
      border-left: 1px solid var(--window-border);
    }

    .window-scrollable::-webkit-scrollbar-thumb {
      background: var(--window-bg);
      border: 1px solid var(--window-border);
    }

    /* Finder Window */
    .finder-window {
      top: 60px;
      left: 40px;
      width: 400px;
    }

    .finder-content {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      padding: 16px;
    }

    .finder-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
    }

    .finder-item:hover .finder-label {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .folder-icon {
      width: 32px;
      height: 26px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      position: relative;
      margin-bottom: 4px;
    }

    .folder-icon::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 2px;
      width: 14px;
      height: 6px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      border-bottom: none;
    }

    .document-icon {
      width: 24px;
      height: 32px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      position: relative;
      margin-bottom: 4px;
    }

    .document-icon::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 8px;
      height: 8px;
      background: var(--window-bg);
      border-left: 1px solid var(--window-border);
      border-bottom: 1px solid var(--window-border);
    }

    .finder-label {
      font-size: 10px;
      text-align: center;
      padding: 1px 3px;
    }

    /* About Window */
    .about-window {
      top: 120px;
      left: 120px;
      width: 340px;
    }

    .about-content {
      text-align: center;
      padding: 24px;
    }

    .macket-icon {
      width: 64px;
      height: 80px;
      margin: 0 auto 16px;
      border: 2px solid var(--window-border);
      background: var(--window-bg);
      position: relative;
    }

    .macket-screen {
      width: 48px;
      height: 36px;
      border: 2px solid var(--window-border);
      margin: 8px auto 4px;
      background: var(--bg-color);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .macket-screen::before {
      content: ':-)';
      font-size: 10px;
    }

    .macket-base {
      width: 56px;
      height: 8px;
      background: var(--window-bg);
      border-top: 2px solid var(--window-border);
      margin: 0 auto;
    }

    .about-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .about-text {
      font-size: 11px;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .about-divider {
      border: none;
      border-top: 1px solid var(--window-border);
      margin: 12px 0;
    }

    /* Button */
    .macket-button {
      background: var(--window-bg);
      border: 2px solid var(--window-border);
      border-radius: 8px;
      padding: 4px 16px;
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 2px 2px 0 var(--window-border);
      color: var(--text-color);
    }

    .macket-button:active {
      background: var(--text-color);
      color: var(--window-bg);
      box-shadow: none;
      transform: translate(2px, 2px);
    }

    /* Trash Icon */
    .trash-icon {
      width: 28px;
      height: 32px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      position: relative;
    }

    .trash-icon::before {
      content: '';
      position: absolute;
      top: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 4px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
    }

    .trash-icon::after {
      content: '';
      position: absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 18px;
      border-left: 1px solid var(--window-border);
      border-right: 1px solid var(--window-border);
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent 4px,
        var(--window-border) 4px,
        var(--window-border) 5px
      );
    }

    /* Floppy disk icon */
    .floppy-icon {
      width: 30px;
      height: 32px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      position: relative;
    }

    .floppy-icon::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 18px;
      height: 10px;
      background: var(--bg-color);
      border: 1px solid var(--window-border);
    }

    .floppy-icon::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 12px;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
    }

    /* HyperCard */
    .hypercard-content {
      padding: 0;
      background: var(--window-bg);
    }

    .hypercard-card {
      padding: 16px;
      min-height: 200px;
      border-bottom: 2px solid var(--window-border);
    }

    .hypercard-title {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 16px;
      text-decoration: underline;
    }

    .hypercard-text {
      font-size: 12px;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .hypercard-button {
      background: var(--window-bg);
      border: 2px solid var(--window-border);
      border-radius: 6px;
      padding: 6px 16px;
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      margin: 4px;
      box-shadow: 1px 1px 0 var(--window-border);
      color: var(--text-color);
    }

    .hypercard-button:active {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .hypercard-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: var(--sidebar-bg);
      border-top: 1px solid var(--window-border);
    }

    .hypercard-nav-btn {
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      padding: 4px 12px;
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      color: var(--text-color);
    }

    .hypercard-nav-btn:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .hypercard-page {
      font-size: 10px;
    }

    /* Git Window */
    .git-wrapper {
      display: flex;
      flex-direction: column;
      height: 350px;
    }

    .git-content {
      padding: 0;
      background: var(--window-bg);
      display: flex;
      flex: 1;
      min-height: 0;
    }

    .git-bottom {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-top: 1px solid var(--window-border);
      background: var(--sidebar-bg);
    }

    .git-commit-input {
      flex: 1;
      padding: 4px 8px;
      font-family: inherit;
      font-size: 11px;
      border: 1px solid var(--window-border);
      background: var(--input-bg);
      color: var(--text-color);
    }

    .git-commit-input:focus {
      outline: none;
    }

    .git-bottom-actions {
      display: flex;
      gap: 6px;
    }

    .git-sidebar {
      width: 200px;
      border-right: 1px solid var(--window-border);
      overflow-y: auto;
      flex-shrink: 0;
    }

    .git-diff-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .git-diff-panel.empty {
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 11px;
    }

    .diff-panel-header {
      padding: 6px 10px;
      border-bottom: 1px solid var(--window-border);
      font-size: 11px;
      font-weight: bold;
      background: var(--sidebar-bg);
      flex-shrink: 0;
    }

    .diff-panel-content {
      flex: 1;
      overflow-y: auto;
      font-family: Monaco, 'Courier New', monospace;
      font-size: 11px;
      background: var(--window-bg);
    }

    .diff-line {
      padding: 1px 8px;
      white-space: pre;
    }

    .diff-line.header {
      background: var(--diff-header-bg);
      color: var(--text-color);
      font-weight: bold;
    }

    .diff-line.added {
      background: var(--diff-added);
      color: var(--diff-added-text);
    }

    .diff-line.removed {
      background: var(--diff-removed);
      color: var(--diff-removed-text);
    }

    .diff-line.context {
      background: var(--window-bg);
      color: var(--text-color);
    }

    .diff-line-number {
      display: inline-block;
      width: 30px;
      text-align: right;
      margin-right: 8px;
      color: var(--text-muted);
      user-select: none;
    }

    .git-section {
      border-bottom: 1px solid var(--window-border);
      padding: 8px;
    }

    .git-section-title {
      font-weight: bold;
      font-size: 11px;
      margin-bottom: 6px;
    }

    .git-branch {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }

    .git-branch-icon {
      font-size: 14px;
    }

    .git-file-list {
      font-size: 11px;
    }

    .git-file-item {
      display: flex;
      align-items: center;
      padding: 3px 4px;
      gap: 6px;
      cursor: pointer;
    }

    .git-file-item:hover {
      background: var(--hover-bg);
    }

    .git-file-item.selected {
      background: var(--selected-bg);
    }

    .git-file-status {
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }

    .git-file-status.modified { color: #b58900; }
    .git-file-status.added { color: #28a745; }
    .git-file-status.deleted { color: #dc3545; }

    .git-file-name {
      flex: 1;
      font-size: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .git-btn {
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      padding: 3px 8px;
      font-family: inherit;
      font-size: 10px;
      cursor: pointer;
      color: var(--text-color);
    }

    .git-btn:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .git-btn-primary {
      background: var(--text-color);
      color: var(--window-bg);
    }

    .git-btn-primary:hover {
      background: var(--hover-bg);
      color: var(--text-color);
    }

    /* Settings Window */
    .settings-content {
      padding: 12px;
      background: var(--window-bg);
      max-height: 350px;
      overflow-y: auto;
    }

    .settings-section {
      margin-bottom: 16px;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-section-title {
      font-weight: bold;
      font-size: 11px;
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--hover-bg);
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 11px;
    }

    .settings-label {
      flex: 1;
    }

    .settings-select {
      padding: 3px 6px;
      font-family: inherit;
      font-size: 10px;
      border: 1px solid var(--window-border);
      background: var(--input-bg);
      color: var(--text-color);
      min-width: 100px;
    }

    .settings-checkbox {
      width: 14px;
      height: 14px;
      cursor: pointer;
    }

    /* Wallpaper Picker */
    .wallpaper-content {
      padding: 12px;
      background: var(--window-bg);
    }

    .wallpaper-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .wallpaper-option {
      width: 100%;
      aspect-ratio: 4/3;
      border: 2px solid var(--window-border);
      cursor: pointer;
      position: relative;
    }

    .wallpaper-option:hover {
      border-color: var(--text-color);
    }

    .wallpaper-option.selected {
      border-color: teal;
      border-width: 3px;
    }

    .wallpaper-option.selected::after {
      content: '✓';
      position: absolute;
      top: 2px;
      right: 4px;
      color: teal;
      font-weight: bold;
    }

    /* Wallpaper patterns */
    .wp-classic {
      background:
        repeating-linear-gradient(0deg, transparent, transparent 1px, var(--bg-color) 1px, var(--bg-color) 2px),
        repeating-linear-gradient(90deg, transparent, transparent 1px, var(--bg-color) 1px, var(--bg-color) 2px);
      background-color: var(--bg-color);
    }

    .wp-solid-gray { background: #808080; }
    .wp-solid-teal { background: #008080; }
    .wp-solid-navy { background: #000080; }
    .wp-gradient-blue { background: linear-gradient(180deg, #87CEEB 0%, #4682B4 100%); }
    .wp-gradient-sunset { background: linear-gradient(180deg, #FF7E5F 0%, #FEB47B 100%); }
    .wp-checkerboard {
      background: repeating-conic-gradient(var(--window-border) 0% 25%, var(--window-bg) 0% 50%) 50% / 20px 20px;
    }
    .wp-diagonal {
      background: repeating-linear-gradient(45deg, var(--bg-color), var(--bg-color) 5px, var(--window-bg) 5px, var(--window-bg) 10px);
    }
    .wp-dots {
      background: radial-gradient(circle, var(--window-border) 1px, transparent 1px);
      background-size: 10px 10px;
      background-color: var(--bg-color);
    }
    .wp-mac-ii {
      background: repeating-conic-gradient(#000 0% 25%, #fff 0% 50%) 50% / 6px 6px;
    }
    .wp-hokusai {
      background: url('assets/hokusai.png') center/cover no-repeat;
    }

    /* UI Alert */
    .ui-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .ui-alert {
      background: var(--window-bg);
      border: 2px solid var(--window-border);
      box-shadow: 2px 2px 0 var(--window-border);
      min-width: 300px;
      max-width: 400px;
    }

    .ui-alert-header {
      background: var(--text-color);
      color: var(--window-bg);
      padding: 4px 8px;
      font-size: 12px;
      font-weight: bold;
    }

    .ui-alert-body {
      padding: 20px;
      text-align: center;
      font-size: 12px;
    }

    .ui-alert-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .ui-alert-buttons {
      padding: 12px;
      display: flex;
      justify-content: center;
      border-top: 1px solid var(--hover-bg);
    }

    .ui-alert-btn {
      background: var(--window-bg);
      border: 2px solid var(--window-border);
      padding: 6px 24px;
      font-family: inherit;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      color: var(--text-color);
    }

    .ui-alert-btn:hover {
      background: var(--text-color);
      color: var(--window-bg);
    }

    /* Tabbed Window */
    .tabbed-window {
      position: absolute;
      background: var(--window-bg);
      border: 1px solid var(--window-border);
      padding: 5px;
      display: flex;
      flex-direction: column;
    }

    .tabbed-window-inner {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--window-bg);
    }

    .tabbed-window-tabs {
      display: flex;
      background: var(--selected-bg);
      border: 2px solid var(--window-border);
      min-height: 24px;
    }

    .tabbed-window-tab {
      padding: 4px 16px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--window-border);
      font-size: 11px;
      cursor: pointer;
      position: relative;
      padding-left: 20px;
    }

    .tabbed-window-tab:hover {
      background: var(--window-bg);
    }

    .tabbed-window-tab.active {
      background: var(--window-bg);
      border-bottom: 2px solid var(--window-bg);
      margin-bottom: -2px;
    }

    .tab-close {
      display: none;
      position: absolute;
      left: 6px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      line-height: 1;
      cursor: pointer;
    }

    .tabbed-window-tab:hover .tab-close {
      display: block;
    }

    .tab-close:hover {
      font-weight: bold;
    }

    .tabbed-window-tab-add {
      padding: 4px 12px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--window-border);
      font-size: 11px;
      cursor: pointer;
    }

    .tabbed-window-tab-add:hover {
      background: var(--window-bg);
    }

    .tabbed-close-box {
      margin: 4px 8px 4px 8px;
      align-self: center;
    }

    .first-tab-with-close {
      border-left: 1px solid var(--window-border);
    }

    .tabbed-window-content {
      flex: 1;
      background: var(--window-bg);
      overflow: hidden;
      display: flex;
      position: relative;
    }

    .tab-pane-container {
      display: none;
      flex: 1;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .tab-pane-container.active {
      display: flex;
    }

    /* Panes */
    .pane {
      flex: 1;
      display: flex;
      background: var(--pane-bg);
      overflow: auto;
      cursor: pointer;
    }

    .pane-multi {
      margin: 2px;
      border: 1px solid var(--window-border);
      position: relative;
      overflow: visible;
    }

    .pane-split-vertical > .pane-multi,
    .pane-split-vertical > .pane-split {
      margin-top: 8px;
    }

    .pane-split-vertical > .pane-multi:first-child,
    .pane-split-vertical > .pane-split:first-child {
      margin-top: 0;
    }

    .tab-pane-container > .pane-split {
      padding-top: 8px;
    }

    .pane-multi.focused {
      border: 2px solid teal;
    }

    .pane-split.parent-highlight {
      background: rgba(0, 128, 128, 0.1);
    }

    .pane-multi.closing-highlight {
      background: rgba(255, 0, 0, 0.2);
    }

    .pane-multi.sibling-highlight {
      background: rgba(0, 128, 128, 0.2);
    }

    .pane-title {
      position: absolute;
      top: -8px;
      left: 8px;
      background: #fff;
      padding: 0 4px;
      font-size: 10px;
      font-weight: bold;
      line-height: 1;
    }

    .pane-content {
      flex: 1;
      padding: 8px;
      overflow: auto;
    }

    .pane-multi .pane-content {
      padding-top: 12px;
    }

    .pane-split {
      flex: 1;
      display: flex;
    }

    .pane-split-vertical {
      flex-direction: column;
    }

    .pane-split-horizontal {
      flex-direction: row;
    }

    /* Upgrade Alert Modal */
    .alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .alert-box {
      background: #fff;
      border: 2px solid #000;
      box-shadow: 4px 4px 0 #000;
      padding: 24px;
      max-width: 320px;
      text-align: center;
    }

    .alert-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 12px;
    }

    .alert-message {
      font-size: 12px;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .alert-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .alert-btn {
      padding: 6px 16px;
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      border: 2px solid #000;
      background: #fff;
    }

    .alert-btn:hover {
      background: #e0e0e0;
    }

    .alert-btn-upgrade {
      background: teal;
      color: #fff;
      border-color: teal;
    }

    .alert-btn-upgrade:hover {
      background: #006666;
    }
  </style>
</head>
<body>
  <!-- Menu Bar -->
  <div class="menu-bar">
    <div class="menu-bar-left">
      <div class="menu-item-container">
        <span class="menu-item menu-item-bold" id="active-window-menu"></span>
        <div class="menu-dropdown" id="active-window-dropdown"></div>
      </div>
    </div>
    <div class="menu-bar-right">
      <div class="menu-item-container">
        <span class="menu-item" id="applications-menu">Applications</span>
        <div class="menu-dropdown" id="applications-dropdown"></div>
      </div>
      <span class="menu-item" id="help-menu">Help</span>
      <span class="menu-item" id="settings-menu">Settings</span>
      <span class="menu-item" id="logout-menu">Logout</span>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="main-layout">
    <!-- Primary Sidebar -->
    <div class="primary-sidebar" id="primary-sidebar">
      <div class="sidebar-section">
        <div class="sidebar-section-header">Workspace</div>
        <div class="sidebar-item active">
          <span class="sidebar-item-icon">&#9642;</span>
          Project Files
        </div>
        <div class="sidebar-item">
          <span class="sidebar-item-icon">&#9642;</span>
          Search
        </div>
        <div class="sidebar-item">
          <span class="sidebar-item-icon">&#9642;</span>
          Source Control
        </div>
      </div>
      <div class="sidebar-section" id="pinned-section">
        <div class="sidebar-section-header">Pinned</div>
        <div id="pinned-files">
          <!-- Pinned files rendered by JavaScript -->
        </div>
      </div>
      <div class="sidebar-section sidebar-section-files">
        <div class="sidebar-section-header">Files</div>
      </div>
      <div class="file-tree" id="file-tree">
        <!-- File tree rendered by JavaScript -->
      </div>
      <div class="sidebar-footer">
        Marketbuffer v1.0
      </div>
    </div>

    <!-- Desktop -->
    <div class="desktop" id="desktop">
      <!-- Windows are rendered dynamically -->
    </div>
  </div>

  <!-- App Cards -->
  <script src="cards/editor.js"></script>
  <script src="cards/finder.js"></script>
  <script src="cards/about.js"></script>
  <script src="cards/hypercard.js"></script>
  <script src="cards/git.js"></script>
  <script src="cards/settings.js"></script>
  <script src="cards/wallpaper.js"></script>
  <script src="cards/terminal.js"></script>
  <script src="cards/changelog.js"></script>
  <script src="cards/neogotchi.js"></script>
  <script src="cards/trinale.js"></script>

  <!-- Server Service (WASM/HTTP abstraction) -->
  <script src="wasm_exec.js"></script>
  <script src="server-service.js"></script>
  <script src="cards/stocks.js"></script>

  <script>
    // ============================================
    // MARKETBUFFER OS - System Object
    // ============================================
    const STATE_KEY = 'marketbuffer_state';

    // Global system object (version loaded from default-state.json)
    const system = {
      version: null,
      state: null,
      close(windowId) {
        closeWindow(windowId);
      },
    };

    // Alias for backward compatibility
    let systemState = null;

    // Load default state from JSON file (source of truth for version)
    async function loadDefaultState() {
      const response = await fetch('default-state.json');
      return response.json();
    }

    // Load state from localStorage or default-state.json
    async function loadSystemState() {
      const defaultState = await loadDefaultState();
      system.version = defaultState.version;

      const saved = localStorage.getItem(STATE_KEY);
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          // Version mismatch - clear and reload
          if (parsed.version !== system.version) {
            console.log(`OS version mismatch: ${parsed.version} !== ${system.version}. Resetting state.`);
            localStorage.clear();
            location.reload();
            return;
          }
          system.state = { ...defaultState, ...parsed };
        } catch (e) {
          console.error('Failed to parse system state:', e);
          localStorage.clear();
          location.reload();
          system.state = { ...defaultState };
        }
      } else {
        // First-time user: use default state
        system.state = { ...defaultState };
      }
      systemState = system.state;
    }

    // Save state to localStorage
    function saveSystemState() {
      system.state.version = system.version;
      localStorage.setItem(STATE_KEY, JSON.stringify(system.state));
    }

    // File type handlers - maps extensions to app IDs
    const fileHandlers = {
      'js': 'editor',
      'jsx': 'editor',
      'ts': 'editor',
      'tsx': 'editor',
      'css': 'editor',
      'html': 'editor',
      'json': 'editor',
      'md': 'editor',
      'txt': 'editor',
      'py': 'editor',
      'rb': 'editor',
      'go': 'editor',
      'rs': 'editor',
      'c': 'editor',
      'cpp': 'editor',
      'h': 'editor',
      'sh': 'editor',
      'yaml': 'editor',
      'yml': 'editor',
      'xml': 'editor',
      'svg': 'editor'
    };

    // OS API: Open a file with the appropriate app
    system.openFile = function(path) {
      const ext = path.split('.').pop().toLowerCase();
      const appId = fileHandlers[ext] || 'editor';
      const card = initialWindows.find(c => c.id === appId);
      if (card && typeof card.openFile === 'function') {
        card.openFile(path);
      }
    };

    // ============================================
    // Pinned files
    // ============================================
    const PINNED_FILES_KEY = 'marketbuffer_pinned_files';
    const DEFAULT_PINNED_FILES = ['demo/README.md'];

    let pinnedFiles = [];

    function loadPinnedFiles() {
      const saved = localStorage.getItem(PINNED_FILES_KEY);
      if (saved) {
        pinnedFiles = JSON.parse(saved);
      } else {
        pinnedFiles = [...DEFAULT_PINNED_FILES];
        savePinnedFiles();
      }
    }

    function savePinnedFiles() {
      localStorage.setItem(PINNED_FILES_KEY, JSON.stringify(pinnedFiles));
    }

    function togglePinFile(path) {
      const index = pinnedFiles.indexOf(path);
      if (index === -1) {
        pinnedFiles.push(path);
      } else {
        pinnedFiles.splice(index, 1);
      }
      savePinnedFiles();
      renderPinnedFiles();
      renderFileTree();
    }

    function unpinFile(path) {
      const index = pinnedFiles.indexOf(path);
      if (index !== -1) {
        pinnedFiles.splice(index, 1);
        savePinnedFiles();
        renderPinnedFiles();
        renderFileTree();
      }
    }

    function renderPinnedFiles() {
      const container = document.getElementById('pinned-files');
      if (pinnedFiles.length === 0) {
        container.innerHTML = '<div class="sidebar-item" style="color: #888; font-style: italic;">No pinned files</div>';
        return;
      }

      let html = '';
      pinnedFiles.forEach(path => {
        const name = path.split('/').pop();
        html += `
          <div class="pinned-item" data-path="${path}">
            <span class="pinned-item-icon">&#128196;</span>
            <span class="pinned-item-name">${name}</span>
            <span class="pinned-item-unpin" data-path="${path}">&#10005;</span>
          </div>
        `;
      });
      container.innerHTML = html;

      // Attach click listeners
      container.querySelectorAll('.pinned-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.classList.contains('pinned-item-unpin')) {
            e.stopPropagation();
            unpinFile(e.target.dataset.path);
          } else {
            system.openFile(item.dataset.path);
          }
        });
      });
    }

    // Initialize pinned files
    loadPinnedFiles();

    // ============================================
    // File tree data structure
    // ============================================
    const fileTreeData = {
      name: 'marketbuffer',
      type: 'folder',
      expanded: true,
      children: [
        {
          name: 'src',
          type: 'folder',
          expanded: true,
          children: [
            {
              name: 'components',
              type: 'folder',
              expanded: false,
              children: [
                { name: 'Button.js', type: 'file', path: 'demo/src/components/Button.js' },
                { name: 'Modal.js', type: 'file', path: 'demo/src/components/Modal.js' },
                { name: 'Sidebar.js', type: 'file', path: 'demo/src/components/Sidebar.js' }
              ]
            },
            {
              name: 'utils',
              type: 'folder',
              expanded: false,
              children: [
                { name: 'helpers.js', type: 'file', path: 'demo/src/utils/helpers.js' },
                { name: 'constants.js', type: 'file', path: 'demo/src/utils/constants.js' }
              ]
            },
            { name: 'index.js', type: 'file', path: 'demo/src/index.js' },
            { name: 'App.js', type: 'file', path: 'demo/src/App.js' }
          ]
        },
        {
          name: 'public',
          type: 'folder',
          expanded: false,
          children: [
            { name: 'index.html', type: 'file', path: 'demo/public/index.html' },
            { name: 'favicon.ico', type: 'file', path: 'demo/public/favicon.ico' }
          ]
        },
        {
          name: 'styles',
          type: 'folder',
          expanded: false,
          children: [
            { name: 'main.css', type: 'file', path: 'demo/styles/main.css' },
            { name: 'variables.css', type: 'file', path: 'demo/styles/variables.css' }
          ]
        },
        { name: 'package.json', type: 'file', path: 'demo/package.json' },
        { name: 'README.md', type: 'file', path: 'demo/README.md' },
        { name: '.gitignore', type: 'file', path: 'demo/.gitignore' }
      ]
    };

    // Cache for loaded file contents (session memory)
    const fileContentsCache = {};

    // Render file tree
    function renderFileTree() {
      // Load saved expansion state before rendering
      loadFileTreeState();

      const container = document.getElementById('file-tree');
      // Render children of root folder directly (don't show root)
      let html = '';
      if (fileTreeData.children) {
        fileTreeData.children.forEach(child => {
          html += renderTreeNode(child, 0);
        });
      }
      container.innerHTML = html;
      attachTreeListeners();
    }

    function renderTreeNode(node, depth) {
      const isFolder = node.type === 'folder';
      const hasChildren = isFolder && node.children && node.children.length > 0;
      const toggleIcon = hasChildren ? (node.expanded ? '&#9660;' : '&#9654;') : '';
      const icon = isFolder ? '&#128193;' : '&#128196;';
      const expandedClass = node.expanded ? 'expanded' : '';
      const pathAttr = node.path ? `data-path="${node.path}"` : '';
      const isPinned = !isFolder && node.path && pinnedFiles.includes(node.path);
      const pinClass = isPinned ? 'pinned' : '';
      const pinIcon = isPinned ? '&#128204;' : '&#128204;'; // pushpin icon

      let html = `
        <div class="tree-item" data-depth="${depth}" data-type="${node.type}" data-name="${node.name}" ${pathAttr}>
          <div class="tree-item-row">
            <span class="tree-toggle">${toggleIcon}</span>
            <span class="tree-icon">${icon}</span>
            <span class="tree-label">${node.name}</span>
            ${!isFolder && node.path ? `<span class="tree-pin ${pinClass}" data-path="${node.path}">${pinIcon}</span>` : ''}
          </div>
      `;

      if (hasChildren) {
        html += `<div class="tree-children ${expandedClass}">`;
        node.children.forEach(child => {
          html += renderTreeNode(child, depth + 1);
        });
        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    function attachTreeListeners() {
      document.querySelectorAll('.tree-item-row').forEach(row => {
        row.addEventListener('click', (e) => {
          // Handle pin button click
          if (e.target.classList.contains('tree-pin')) {
            e.stopPropagation();
            const path = e.target.dataset.path;
            if (path) {
              togglePinFile(path);
            }
            return;
          }

          e.stopPropagation();
          const item = row.closest('.tree-item');
          const type = item.dataset.type;
          const name = item.dataset.name;
          const path = item.dataset.path;

          // Handle selection
          document.querySelectorAll('.tree-item-row.selected').forEach(el => {
            el.classList.remove('selected');
          });
          row.classList.add('selected');

          // Toggle folder expansion
          if (type === 'folder') {
            const children = item.querySelector('.tree-children');
            const toggle = row.querySelector('.tree-toggle');
            if (children) {
              const isExpanded = children.classList.toggle('expanded');
              toggle.innerHTML = isExpanded ? '&#9660;' : '&#9654;';
              // Update data model and save to localStorage
              updateNodeExpanded(fileTreeData, name, isExpanded);
              saveFileTreeState();
            }
          } else if (type === 'file' && path) {
            // Open file with appropriate app
            system.openFile(path);
          }
        });
      });
    }

    function updateNodeExpanded(node, name, expanded) {
      if (node.name === name) {
        node.expanded = expanded;
        return true;
      }
      if (node.children) {
        for (const child of node.children) {
          if (updateNodeExpanded(child, name, expanded)) return true;
        }
      }
      return false;
    }

    // Save file tree expansion state to systemState
    function saveFileTreeState() {
      const state = {};
      collectExpansionState(fileTreeData, state);
      systemState.fileTree = state;
      saveSystemState();
    }

    function collectExpansionState(node, state) {
      if (node.type === 'folder') {
        state[node.name] = node.expanded || false;
      }
      if (node.children) {
        node.children.forEach(child => collectExpansionState(child, state));
      }
    }

    function loadFileTreeState() {
      if (systemState.fileTree && Object.keys(systemState.fileTree).length > 0) {
        applyExpansionState(fileTreeData, systemState.fileTree);
      }
    }

    function applyExpansionState(node, state) {
      if (node.type === 'folder' && state.hasOwnProperty(node.name)) {
        node.expanded = state[node.name];
      }
      if (node.children) {
        node.children.forEach(child => applyExpansionState(child, state));
      }
    }

    // Initial windows configuration (loaded from cards/*.js)
    const initialWindows = [
      editorCard,
      finderCard,
      aboutCard,
      hypercardCard,
      gitCard,
      settingsCard,
      wallpaperCard,
      changelogCard,
      neogotchiCard,
      trinaleCard,
      stocksCard,
    ];

    // Open windows list (copy from initial on load)
    let openWindows = [];

    // Active window ID
    let activeWindowId = null;

    // Dragging state
    let activeWindow = null;
    let offsetX = 0;
    let offsetY = 0;

    // Save windows state to systemState
    function saveState() {
      const state = openWindows.map(win => ({
        id: win.id,
        zIndex: win.zIndex,
        top: win.top,
        left: win.left,
        right: win.right,
        bottom: win.bottom,
        activeTab: win.activeTab,
        tabs: win.tabs ? win.tabs.map(tab => ({
          ...tab,
          panes: tab.panes && editorCard ? editorCard.stripPaneContent(tab.panes) : null
        })) : undefined
      }));
      systemState.windows = state;
      saveSystemState();
    }

    // Load windows state from systemState
    function loadState() {
      // Check if windows array exists (even if empty) - means user has saved state
      if (systemState.windows !== null && systemState.windows !== undefined) {
        try {
          // Merge saved state with initial windows (to get non-serialized properties)
          openWindows = systemState.windows.map(savedWin => {
            const initialWin = initialWindows.find(w => w.id === savedWin.id);
            if (initialWin) {
              const merged = { ...initialWin, ...savedWin };
              // Restore pane content for tabbed windows
              if (merged.tabs && editorCard) {
                merged.tabs = merged.tabs.map(tab => ({
                  ...tab,
                  panes: tab.panes ? editorCard.restorePaneContent(tab.panes) : null
                }));
              }
              return merged;
            }
            return null;
          }).filter(Boolean);
          return true;
        } catch (e) {
          console.error('Failed to load state:', e);
        }
      }
      return false;
    }

    // Initialize on page load
    async function init() {
      // Load system state first (fetches version from default-state.json)
      await loadSystemState();

      // Apply theme, font size, and wallpaper after state is loaded
      loadTheme();
      loadFontSize();
      loadWallpaper();

      // Render file tree and pinned files in sidebar
      renderPinnedFiles();
      renderFileTree();

      // Try to load from localStorage, otherwise use initial windows
      if (!loadState()) {
        // Open only default windows, not all
        const defaultWindowIds = systemState.defaultWindows || ['editor', 'about'];
        openWindows = initialWindows
          .filter(win => defaultWindowIds.includes(win.id))
          .map(win => ({ ...win }));
      }
      renderWindows();

      // Inject styles from all cards
      initialWindows.forEach(card => {
        if (card.styles) {
          const styleEl = document.createElement('style');
          styleEl.textContent = card.styles;
          document.head.appendChild(styleEl);
        }
      });

      // Set initial active window to the one with highest zIndex
      if (openWindows.length > 0) {
        const topWindow = openWindows.reduce((a, b) => a.zIndex > b.zIndex ? a : b);
        activeWindowId = topWindow.id;
        updateActiveWindowMenu();
      }

      // Reload file contents for all tabs
      await reloadAllTabFiles();

      // Initialize terminal (slide-out from bottom)
      initTerminal();
    }

    // Reload file contents for all tabs that have a filePath
    async function reloadAllTabFiles() {
      if (typeof editorCard !== 'undefined' && typeof editorCard.reloadAllFiles === 'function') {
        await editorCard.reloadAllFiles();
      }
    }

    // Initialize terminal prompt box
    function initTerminal() {
      if (typeof terminalCard === 'undefined') return;

      // Inject terminal styles
      if (terminalCard.styles) {
        const styleEl = document.createElement('style');
        styleEl.textContent = terminalCard.styles;
        document.head.appendChild(styleEl);
      }

      // Create terminal prompt box element
      const terminalEl = document.createElement('div');
      terminalEl.className = 'terminal-prompt-box';
      terminalEl.id = 'terminal-prompt-box';
      terminalEl.innerHTML = terminalCard.render();
      document.body.appendChild(terminalEl);

      // Initialize terminal state
      terminalCard.init(system);

      // Handle focus on input - expand terminal
      const input = document.getElementById('terminal-input');
      if (input) {
        input.addEventListener('focus', () => {
          terminalCard.expand();
        });
      }

      // Handle clicks in terminal
      terminalEl.addEventListener('click', (e) => {
        terminalCard.handleClick(e);
      });

      // Handle keyboard in terminal
      terminalEl.addEventListener('keydown', (e) => {
        terminalCard.handleKeydown(e);
      });

      // Global keyboard shortcut: Ctrl+` or Cmd+` to toggle terminal
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === '`') {
          e.preventDefault();
          terminalCard.toggle();
        }
      });
    }

    // Render all open windows
    function renderWindows() {
      const desktop = document.getElementById('desktop');
      desktop.innerHTML = '';

      openWindows.forEach((win, index) => {
        const windowEl = document.createElement('div');

        if (win.tabbed) {
          // Tabbed window - delegate rendering to the card
          windowEl.className = 'tabbed-window';
          windowEl.id = 'tabbed-window';
          windowEl.dataset.windowId = win.id;
          windowEl.style.zIndex = win.zIndex;
          windowEl.style.top = win.top + 'px';
          windowEl.style.left = win.left + 'px';
          windowEl.style.right = win.right + 'px';
          windowEl.style.bottom = win.bottom + 'px';

          // Find the card and use its render method
          const card = initialWindows.find(c => c.id === win.id);
          if (card && typeof card.render === 'function') {
            windowEl.innerHTML = card.render(win);
          }
        } else {
          // Regular window - positioned relative to desktop container
          windowEl.className = `window ${win.draggable ? 'window-draggable' : ''}`;
          windowEl.dataset.windowId = win.id;
          windowEl.style.top = win.top + 'px';
          windowEl.style.right = win.right + 'px';
          windowEl.style.width = win.width + 'px';
          windowEl.style.zIndex = win.zIndex;

          const closeBoxHtml = win.closeable
            ? `<div class="close-box" data-window-id="${win.id}"></div>`
            : '';

          const contentHtml = typeof win.content === 'function' ? win.content() : win.content;
          windowEl.innerHTML = `
            <div class="window-title-bar">
              ${closeBoxHtml}
              <span class="window-title">${win.title}</span>
            </div>
            ${contentHtml}
          `;
        }

        desktop.appendChild(windowEl);

        // Call init() after DOM is ready
        if (typeof win.init === 'function') {
          win.init(system);
        }
      });

      attachEventListeners();
      // Setup tabbed window listeners via editorCard
      if (typeof editorCard !== 'undefined' && typeof editorCard.setupEventListeners === 'function') {
        editorCard.setupEventListeners();
        editorCard.initializeEditors();
      }
    }

    // Attach event listeners after rendering
    function attachEventListeners() {
      // Close button handlers (skip tabbed window, handled separately)
      document.querySelectorAll('.window .close-box').forEach(closeBox => {
        closeBox.addEventListener('click', (e) => {
          e.stopPropagation();
          e.stopImmediatePropagation();
          e.preventDefault();
          const windowId = e.target.dataset.windowId;
          closeWindow(windowId);
        }, true);
        closeBox.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          e.stopImmediatePropagation();
          e.preventDefault();
        }, true);
      });

      // Draggable window handlers
      document.querySelectorAll('.window-draggable .window-title-bar').forEach(titleBar => {
        titleBar.addEventListener('mousedown', (e) => {
          if (e.target.closest('.close-box')) return;

          activeWindow = titleBar.closest('.window');
          const rect = activeWindow.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;

          // Bring window to front
          bringToFront(activeWindow);
        });
      });

      // Click to bring window to front (all windows, not just draggable)
      document.querySelectorAll('.window').forEach(win => {
        win.addEventListener('mousedown', (e) => {
          if (e.target.closest('.close-box')) return;
          bringToFront(win);
        });

        // Delegate clicks to card's handleClick
        win.addEventListener('click', (e) => {
          const windowId = win.dataset.windowId;
          const card = initialWindows.find(c => c.id === windowId);
          if (card && typeof card.handleClick === 'function') {
            card.handleClick(e);
          }
        });
      });
    }

    // Close a window (only if closeable)
    function closeWindow(windowId) {
      // Check if window exists and is closeable
      const win = openWindows.find(w => w.id === windowId);
      const initialWin = initialWindows.find(w => w.id === windowId);
      const isCloseable = win ? win.closeable : (initialWin ? initialWin.closeable : true);

      if (!isCloseable) return; // Can't close non-closeable windows

      // Remove window element from DOM
      const windowEl = document.querySelector(`.window[data-window-id="${windowId}"], .tabbed-window[data-window-id="${windowId}"]`);
      if (windowEl) {
        windowEl.remove();
      }

      // Remove from openWindows if present
      const wasInArray = openWindows.some(w => w.id === windowId);
      openWindows = openWindows.filter(w => w.id !== windowId);

      // Update active window
      if (activeWindowId === windowId || !wasInArray) {
        if (openWindows.length > 0) {
          const topWindow = openWindows.reduce((a, b) => a.zIndex > b.zIndex ? a : b);
          activeWindowId = topWindow.id;
        } else {
          activeWindowId = null;
        }
        updateActiveWindowMenu();
      }

      saveState();
    }

    // Bring window to front
    function bringToFront(windowEl) {
      const windowId = windowEl.dataset.windowId;

      // Check if window is actually in our managed list
      const win = openWindows.find(w => w.id === windowId);
      if (!win) return; // Don't bring to front if not in openWindows

      // Update zIndex in openWindows array
      openWindows.forEach(w => {
        if (w.tabbed) {
          w.zIndex = 50;
        } else {
          w.zIndex = 100;
        }
      });
      win.zIndex = 200;

      // Update DOM
      document.querySelectorAll('.window').forEach(w => w.style.zIndex = 100);
      const tabbedWin = document.getElementById('tabbed-window');
      if (tabbedWin) tabbedWin.style.zIndex = 50;
      windowEl.style.zIndex = 200;

      // Set active window
      activeWindowId = windowId;
      updateActiveWindowMenu();

      saveState();
    }

    // Bring tabbed window to front
    function bringTabbedToFront() {
      // Update zIndex in openWindows array
      const tabbedWindow = openWindows.find(w => w.tabbed);
      openWindows.forEach(w => {
        if (w.tabbed) {
          w.zIndex = 200;
        } else {
          w.zIndex = 100;
        }
      });

      // Update DOM
      document.querySelectorAll('.window').forEach(w => w.style.zIndex = 100);
      const tabbedWin = document.getElementById('tabbed-window');
      if (tabbedWin) tabbedWin.style.zIndex = 200;

      // Set active window
      if (tabbedWindow) {
        activeWindowId = tabbedWindow.id;
        updateActiveWindowMenu();
      }

      saveState();
    }

    // Mouse move handler for dragging
    document.addEventListener('mousemove', (e) => {
      if (!activeWindow) return;

      const desktop = document.getElementById('desktop');
      const desktopRect = desktop.getBoundingClientRect();
      const windowWidth = activeWindow.offsetWidth;
      const windowHeight = activeWindow.offsetHeight;

      // Calculate position relative to desktop
      let top = e.clientY - desktopRect.top - offsetY;
      let right = desktopRect.right - e.clientX - (windowWidth - offsetX);

      // Constrain to desktop bounds (all four edges)
      const maxTop = desktopRect.height - windowHeight;
      const maxRight = desktopRect.width - windowWidth;

      top = Math.max(0, Math.min(top, maxTop));
      right = Math.max(0, Math.min(right, maxRight));

      activeWindow.style.top = top + 'px';
      activeWindow.style.right = right + 'px';

      // Update position in openWindows array
      const windowId = activeWindow.dataset.windowId;
      const win = openWindows.find(w => w.id === windowId);
      if (win) {
        win.top = top;
        win.right = right;
      }
    });

    document.addEventListener('mouseup', () => {
      if (activeWindow) {
        saveState();
      }
      activeWindow = null;
    });

    // Initialize
    init();

    // Theme management
    function applyTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
      } else {
        document.body.classList.remove('dark-theme');
      }
      // Update select if it exists
      const themeSelect = document.getElementById('setting-theme');
      if (themeSelect) {
        themeSelect.value = theme;
      }
      // Toggle wb-dark class on all editor elements
      document.querySelectorAll('.playground.wb').forEach(editor => {
        if (theme === 'dark') {
          editor.classList.add('wb-dark');
        } else {
          editor.classList.remove('wb-dark');
        }
      });
    }

    function loadTheme() {
      applyTheme(systemState.theme);
    }

    function saveTheme(theme) {
      systemState.theme = theme;
      saveSystemState();
    }

    // Listen for theme changes (using event delegation since settings may not be open)
    document.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'setting-theme') {
        const theme = e.target.value;
        applyTheme(theme);
        saveTheme(theme);
      }
    });

    // Font size management
    function applyFontSize(size) {
      // Remove all font size classes
      document.body.classList.remove('font-small', 'font-medium', 'font-large');
      // Add the selected one
      document.body.classList.add('font-' + size);
      // Update select if it exists
      const fontSizeSelect = document.getElementById('setting-font-size');
      if (fontSizeSelect) {
        fontSizeSelect.value = size;
      }
    }

    function loadFontSize() {
      applyFontSize(systemState.fontSize);
    }

    function saveFontSize(size) {
      systemState.fontSize = size;
      saveSystemState();
    }

    // Listen for font size changes
    document.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'setting-font-size') {
        const size = e.target.value;
        applyFontSize(size);
        saveFontSize(size);
      }
    });

    // Delegate change events to cards
    document.addEventListener('change', (e) => {
      const windowEl = e.target.closest('[data-window-id]');
      if (windowEl) {
        const windowId = windowEl.dataset.windowId;
        const card = initialWindows.find(c => c.id === windowId);
        if (card && typeof card.handleChange === 'function') {
          card.handleChange(e);
        }
      }
    });

    // Delegate mouse events to cards (for tooltips etc)
    document.addEventListener('mouseover', (e) => {
      const windowEl = e.target.closest('[data-window-id]');
      if (windowEl) {
        const windowId = windowEl.dataset.windowId;
        const card = initialWindows.find(c => c.id === windowId);
        if (card && typeof card.handleMouseOver === 'function') {
          card.handleMouseOver(e);
        }
      }
    });

    document.addEventListener('mousemove', (e) => {
      const windowEl = e.target.closest('[data-window-id]');
      if (windowEl) {
        const windowId = windowEl.dataset.windowId;
        const card = initialWindows.find(c => c.id === windowId);
        if (card && typeof card.handleMouseMove === 'function') {
          card.handleMouseMove(e);
        }
      }
    });

    document.addEventListener('mouseout', (e) => {
      const windowEl = e.target.closest('[data-window-id]');
      if (windowEl) {
        const windowId = windowEl.dataset.windowId;
        const card = initialWindows.find(c => c.id === windowId);
        if (card && typeof card.handleMouseOut === 'function') {
          card.handleMouseOut(e);
        }
      }
    });

    // Wallpaper management
    const wallpaperClasses = ['wp-classic', 'wp-solid-gray', 'wp-solid-teal', 'wp-solid-navy', 'wp-gradient-blue', 'wp-gradient-sunset', 'wp-checkerboard', 'wp-diagonal', 'wp-dots', 'wp-mac-ii', 'wp-hokusai'];

    function applyWallpaper(wallpaper) {
      const desktop = document.getElementById('desktop');
      if (!desktop) return;

      // Remove all wallpaper classes
      wallpaperClasses.forEach(cls => desktop.classList.remove(cls));
      // Add the selected one
      desktop.classList.add('wp-' + wallpaper);

      // Update selection UI if wallpaper picker is open
      document.querySelectorAll('.wallpaper-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.wallpaper === wallpaper) {
          opt.classList.add('selected');
        }
      });
    }

    function loadWallpaper() {
      applyWallpaper(systemState.wallpaper);
    }

    function saveWallpaper(wallpaper) {
      systemState.wallpaper = wallpaper;
      saveSystemState();
    }

    // Listen for wallpaper clicks (using event delegation)
    document.addEventListener('click', (e) => {
      const wallpaperOption = e.target.closest('.wallpaper-option');
      if (wallpaperOption && wallpaperOption.dataset.wallpaper) {
        const wallpaper = wallpaperOption.dataset.wallpaper;
        applyWallpaper(wallpaper);
        saveWallpaper(wallpaper);
      }
    });

    // Highlight a file in the file tree by its path
    function highlightFileInTree(filePath) {
      // Remove existing selection
      document.querySelectorAll('.tree-item-row.selected').forEach(el => {
        el.classList.remove('selected');
      });

      // Find and select the matching file
      const fileItem = document.querySelector(`.tree-item[data-path="${filePath}"]`);
      if (fileItem) {
        const row = fileItem.querySelector('.tree-item-row');
        if (row) {
          row.classList.add('selected');
        }
      }
    }

    // Show upgrade alert when pane limit is reached
    function showUpgradeAlert() {
      const overlay = document.createElement('div');
      overlay.className = 'alert-overlay';
      overlay.innerHTML = `
        <div class="alert-box">
          <div class="alert-title">Pane Limit Reached</div>
          <div class="alert-message">
            You cannot open more than 8 panes per tab on the free plan.
            Upgrade to Pro for unlimited panes and advanced features.
          </div>
          <div class="alert-buttons">
            <button class="alert-btn" id="alert-cancel">Cancel</button>
            <button class="alert-btn alert-btn-upgrade" id="alert-upgrade">Upgrade</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);

      document.getElementById('alert-cancel').addEventListener('click', () => {
        overlay.remove();
      });

      document.getElementById('alert-upgrade').addEventListener('click', () => {
        // Handle upgrade action
        overlay.remove();
      });

      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
        }
      });
    }

    // Active window menu
    function updateActiveWindowMenu() {
      const menuItem = document.getElementById('active-window-menu');
      const win = openWindows.find(w => w.id === activeWindowId);
      if (win) {
        menuItem.textContent = win.title;
      } else {
        menuItem.textContent = '';
      }
    }

    function renderActiveWindowDropdown() {
      const dropdown = document.getElementById('active-window-dropdown');
      dropdown.innerHTML = '';

      const win = openWindows.find(w => w.id === activeWindowId);
      if (!win || !win.contextMenu) return;

      win.contextMenu.forEach(item => {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-dropdown-item';
        menuItem.textContent = item.label;
        menuItem.addEventListener('click', (e) => {
          e.stopPropagation();
          highlightParentSplit(false);
          executeContextMenuAction(win.id, item.action);
          closeActiveWindowMenu();
        });

        // Add hover highlight for close-pane
        if (item.action === 'close-pane') {
          menuItem.addEventListener('mouseenter', () => {
            highlightParentSplit(true);
          });
          menuItem.addEventListener('mouseleave', () => {
            highlightParentSplit(false);
          });
        }

        dropdown.appendChild(menuItem);
      });
    }

    function executeContextMenuAction(windowId, action) {
      // Find the card and delegate action
      const card = initialWindows.find(c => c.id === windowId);
      if (card && typeof card.executeAction === 'function') {
        card.executeAction(action);
      } else if (action === 'close') {
        system.close(windowId);
      }
    }

    function highlightParentSplit(show) {
      // Delegate to editorCard
      if (typeof editorCard !== 'undefined' && typeof editorCard.highlightParentSplit === 'function') {
        editorCard.highlightParentSplit(show);
      }
    }

    function toggleActiveWindowMenu() {
      const dropdown = document.getElementById('active-window-dropdown');
      const isOpen = dropdown.classList.contains('open');
      if (isOpen) {
        closeActiveWindowMenu();
      } else {
        renderActiveWindowDropdown();
        dropdown.classList.add('open');
      }
    }

    function closeActiveWindowMenu() {
      const dropdown = document.getElementById('active-window-dropdown');
      dropdown.classList.remove('open');
      highlightParentSplit(false);
    }

    // Applications menu
    function renderApplicationsMenu() {
      const dropdown = document.getElementById('applications-dropdown');
      dropdown.innerHTML = '';

      initialWindows.forEach(win => {
        const isOpen = openWindows.some(w => w.id === win.id);
        const item = document.createElement('div');
        item.className = `menu-dropdown-item ${isOpen ? 'checked' : ''}`;
        item.textContent = win.title;
        item.dataset.windowId = win.id;
        item.addEventListener('click', () => {
          openApplication(win.id);
          closeApplicationsMenu();
        });
        dropdown.appendChild(item);
      });

      // Add separator and close all option
      const separator = document.createElement('div');
      separator.className = 'menu-dropdown-separator';
      dropdown.appendChild(separator);

      const closeAllItem = document.createElement('div');
      closeAllItem.className = 'menu-dropdown-item';
      closeAllItem.textContent = 'Close All Windows';
      closeAllItem.addEventListener('click', () => {
        openWindows.slice().forEach(w => system.close(w.id));
        closeApplicationsMenu();
      });
      dropdown.appendChild(closeAllItem);
    }

    function openApplication(windowId) {
      const isOpen = openWindows.some(w => w.id === windowId);
      if (!isOpen) {
        const win = initialWindows.find(w => w.id === windowId);
        if (win) {
          // Clean up any stale DOM element with the same ID
          const existingEl = document.querySelector(`[data-window-id="${windowId}"]`);
          if (existingEl) existingEl.remove();

          // Reset all z-indexes in data and DOM
          openWindows.forEach(w => {
            w.zIndex = w.tabbed ? 50 : 100;
            const el = document.querySelector(`[data-window-id="${w.id}"]`);
            if (el) el.style.zIndex = w.zIndex;
          });
          // Add new window with highest z-index
          const newWin = { ...win, zIndex: 200 };

          // Ensure tabbed windows have at least one tab
          if (newWin.tabbed && (!newWin.tabs || newWin.tabs.length === 0)) {
            // Find the card and let it initialize its default state
            const card = initialWindows.find(c => c.id === newWin.id);
            if (card && typeof card.initDefaultTab === 'function') {
              card.initDefaultTab(newWin);
            }
          }

          openWindows.push(newWin);
          // Set as active window
          activeWindowId = windowId;
          saveState();
          // Render just the new window (DOM manipulation)
          renderSingleWindow(newWin);
          updateActiveWindowMenu();
        }
      }
    }

    function renderSingleWindow(win) {
      const desktop = document.getElementById('desktop');
      const windowEl = document.createElement('div');

      if (win.tabbed) {
        // Tabbed window - delegate rendering to the card
        windowEl.className = 'tabbed-window';
        windowEl.id = 'tabbed-window';
        windowEl.dataset.windowId = win.id;
        windowEl.style.zIndex = win.zIndex;
        windowEl.style.top = win.top + 'px';
        windowEl.style.left = win.left + 'px';
        windowEl.style.right = win.right + 'px';
        windowEl.style.bottom = win.bottom + 'px';

        // Find the card and use its render method
        const card = initialWindows.find(c => c.id === win.id);
        if (card && typeof card.render === 'function') {
          windowEl.innerHTML = card.render(win);
        }

        desktop.appendChild(windowEl);

        // Setup tabbed window listeners via editorCard
        if (typeof editorCard !== 'undefined' && typeof editorCard.setupEventListeners === 'function') {
          editorCard.setupEventListeners();
          editorCard.initializeEditors();
        }
      } else {
        // Regular window
        windowEl.className = `window ${win.draggable ? 'window-draggable' : ''}`;
        windowEl.dataset.windowId = win.id;
        windowEl.style.top = win.top + 'px';
        windowEl.style.right = win.right + 'px';
        windowEl.style.width = win.width + 'px';
        windowEl.style.zIndex = win.zIndex;

        const closeBoxHtml = win.closeable
          ? `<div class="close-box" data-window-id="${win.id}"></div>`
          : '';

        // Call init() on win before rendering content so it can set up state
        if (typeof win.init === 'function') {
          win.init(system);
        }

        const contentHtml = typeof win.content === 'function' ? win.content() : win.content;
        windowEl.innerHTML = `
          <div class="window-title-bar">
            ${closeBoxHtml}
            <span class="window-title">${win.title}</span>
          </div>
          ${contentHtml}
        `;

        desktop.appendChild(windowEl);
        attachWindowEventListeners(windowEl, win);
      }
    }

    function attachWindowEventListeners(windowEl, win) {
      // Close box
      const closeBox = windowEl.querySelector('.close-box');
      if (closeBox) {
        closeBox.addEventListener('click', (e) => {
          e.stopPropagation();
          e.stopImmediatePropagation();
          e.preventDefault();
          closeWindow(win.id);
        }, true);
        closeBox.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          e.stopImmediatePropagation();
          e.preventDefault();
        }, true);
      }

      // Dragging
      if (win.draggable) {
        const titleBar = windowEl.querySelector('.window-title-bar');
        if (titleBar) {
          titleBar.addEventListener('mousedown', (e) => {
            if (e.target.closest('.close-box')) return;
            activeWindow = windowEl;
            const rect = windowEl.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            bringToFront(windowEl);
          });
        }
      }

      // Bring to front on click
      windowEl.addEventListener('mousedown', (e) => {
        if (e.target.closest('.close-box')) return;
        bringToFront(windowEl);
      });

      // Delegate clicks to card's handleClick
      windowEl.addEventListener('click', (e) => {
        const card = initialWindows.find(c => c.id === win.id);
        if (card && typeof card.handleClick === 'function') {
          card.handleClick(e);
        }
      });

      // Re-attach git file handlers if this is the git window
      if (win.id === 'git' && typeof gitCard !== 'undefined') {
        gitCard.init();
      }

      // Sync settings selects if this is the settings window
      if (win.id === 'settings') {
        const themeSelect = document.getElementById('setting-theme');
        if (themeSelect) {
          themeSelect.value = systemState.theme;
        }
        const fontSizeSelect = document.getElementById('setting-font-size');
        if (fontSizeSelect) {
          fontSizeSelect.value = systemState.fontSize;
        }
      }

      // Sync wallpaper selection if this is the wallpaper window
      if (win.id === 'wallpaper') {
        document.querySelectorAll('.wallpaper-option').forEach(opt => {
          opt.classList.remove('selected');
          if (opt.dataset.wallpaper === systemState.wallpaper) {
            opt.classList.add('selected');
          }
        });
      }
    }

    function toggleApplicationsMenu() {
      const dropdown = document.getElementById('applications-dropdown');
      const isOpen = dropdown.classList.contains('open');
      if (isOpen) {
        closeApplicationsMenu();
      } else {
        renderApplicationsMenu();
        dropdown.classList.add('open');
      }
    }

    function closeApplicationsMenu() {
      const dropdown = document.getElementById('applications-dropdown');
      dropdown.classList.remove('open');
    }

    // Active window menu event listeners
    document.getElementById('active-window-menu').addEventListener('click', (e) => {
      e.stopPropagation();
      closeApplicationsMenu();
      toggleActiveWindowMenu();
    });

    // Applications menu event listeners
    document.getElementById('applications-menu').addEventListener('click', (e) => {
      e.stopPropagation();
      closeActiveWindowMenu();
      toggleApplicationsMenu();
    });

    // Settings menu click handler
    document.getElementById('settings-menu').addEventListener('click', (e) => {
      e.stopPropagation();
      closeApplicationsMenu();
      closeActiveWindowMenu();
      openApplication('settings');
    });

    // Help menu click handler - opens terminal and types out "help" to teach users
    document.getElementById('help-menu').addEventListener('click', (e) => {
      e.stopPropagation();
      closeApplicationsMenu();
      closeActiveWindowMenu();
      if (typeof terminalCard !== 'undefined') {
        terminalCard.expand();
        const input = document.getElementById('terminal-input');
        if (input) {
          input.focus();
          input.disabled = true;
          input.value = '';

          const text = 'help';
          let i = 0;
          const typeInterval = setInterval(() => {
            if (i < text.length) {
              input.value += text[i];
              i++;
            } else {
              clearInterval(typeInterval);
              // Wait 1 second then execute
              setTimeout(() => {
                input.disabled = false;
                terminalCard.executeCommand('help');
                input.value = '';
                input.focus();
              }, 1000);
            }
          }, 250); // 1 second / 4 chars = 250ms per char
        }
      }
    });

    // Logout menu click handler
    document.getElementById('logout-menu').addEventListener('click', (e) => {
      e.stopPropagation();
      closeApplicationsMenu();
      closeActiveWindowMenu();
      showUIAlert('This is a demo. There is no account to log out of.');
    });

    document.addEventListener('click', (e) => {
      closeApplicationsMenu();
      closeActiveWindowMenu();
      // Close terminal if clicking outside of it
      if (typeof terminalCard !== 'undefined' && terminalCard.isExpanded) {
        const terminalBox = document.getElementById('terminal-prompt-box');
        if (terminalBox && !terminalBox.contains(e.target)) {
          terminalCard.collapse();
        }
      }
    });

    // Global close box handler - handles close on mousedown before anything else
    document.addEventListener('mousedown', (e) => {
      const closeBox = e.target.closest('.close-box');
      if (closeBox) {
        e.stopPropagation();
        e.stopImmediatePropagation();
        e.preventDefault();
        const windowId = closeBox.dataset.windowId;
        if (windowId) {
          closeWindow(windowId);
        }
      }
    }, true);

    // OS Alert dialog
    function showUIAlert(title, message) {
      const overlay = document.createElement('div');
      overlay.className = 'ui-alert-overlay';
      overlay.innerHTML = `
        <div class="ui-alert">
          <div class="ui-alert-header">${title}</div>
          <div class="ui-alert-body">
            <div class="ui-alert-icon">&#9888;</div>
            <div>${message}</div>
          </div>
          <div class="ui-alert-buttons">
            <button class="ui-alert-btn">OK</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);

      const closeAlert = () => overlay.remove();
      overlay.querySelector('.ui-alert-btn').onclick = closeAlert;
      overlay.onclick = (e) => { if (e.target === overlay) closeAlert(); };
    }
  </script>
</body>
</html>
