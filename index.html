<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketbuffer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Chicago&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Chicago', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      background: #a8a8a8;
      min-height: 100vh;
      cursor: default;
      user-select: none;
    }

    /* Menu Bar */
    .menu-bar {
      background: #fff;
      border-bottom: 2px solid #000;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .menu-bar-left {
      display: flex;
      align-items: center;
    }

    .menu-bar-right {
      display: flex;
      align-items: center;
    }

    .menu-item {
      padding: 2px 12px;
      cursor: pointer;
    }

    .menu-item-bold {
      font-weight: bold;
    }

    .menu-item:hover {
      background: #000;
      color: #fff;
    }

    .menu-item-container {
      position: relative;
    }

    .menu-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: #fff;
      border: 1px solid #000;
      box-shadow: 2px 2px 0 #000;
      min-width: 180px;
      z-index: 1001;
    }

    .menu-dropdown.open {
      display: block;
    }

    .menu-dropdown-item {
      padding: 4px 12px 4px 24px;
      cursor: pointer;
      position: relative;
      white-space: nowrap;
    }

    .menu-dropdown-item:hover {
      background: #000;
      color: #fff;
    }

    .menu-dropdown-item.checked::before {
      content: 'âœ“';
      position: absolute;
      left: 8px;
    }

    /* Desktop */
    .desktop {
      padding-top: 24px;
      min-height: 100vh;
      background:
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 1px,
          #a8a8a8 1px,
          #a8a8a8 2px
        ),
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 1px,
          #a8a8a8 1px,
          #a8a8a8 2px
        );
      background-color: #a8a8a8;
    }

    /* Desktop Icons */
    .desktop-icons {
      position: absolute;
      top: 30px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .desktop-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 64px;
      cursor: pointer;
    }

    .desktop-icon:hover .icon-label {
      background: #000;
      color: #fff;
    }

    .icon-image {
      width: 32px;
      height: 32px;
      background: #fff;
      border: 1px solid #000;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 4px;
    }

    .icon-label {
      font-size: 10px;
      text-align: center;
      padding: 1px 3px;
    }

    /* Window */
    .window {
      position: absolute;
      background: #fff;
      border: 2px solid #000;
      box-shadow: 2px 2px 0 #000;
      min-width: 300px;
      left: auto;
    }

    .window-title-bar {
      background: #fff;
      border-bottom: 2px solid #000;
      padding: 2px 4px;
      display: flex;
      align-items: center;
      height: 20px;
    }

    .window-draggable .window-title-bar {
      cursor: move;
    }

    .window-title-bar::before,
    .window-title-bar::after {
      content: '';
      flex: 1;
      height: 10px;
      background: repeating-linear-gradient(
        0deg,
        #000,
        #000 1px,
        #fff 1px,
        #fff 3px
      );
    }

    .window-title {
      padding: 0 8px;
      font-weight: bold;
      font-size: 12px;
      white-space: nowrap;
    }

    .close-box {
      width: 12px;
      height: 12px;
      border: 1px solid #000;
      background: #fff;
      margin-right: 4px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .close-box:hover {
      background: #000;
    }

    .window-content {
      padding: 16px;
      background: #fff;
    }

    /* Scrollbar styling for window */
    .window-scrollable {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #000;
      margin: 8px;
      background: #fff;
    }

    .window-scrollable::-webkit-scrollbar {
      width: 16px;
    }

    .window-scrollable::-webkit-scrollbar-track {
      background:
        repeating-linear-gradient(
          45deg,
          #fff,
          #fff 2px,
          #a8a8a8 2px,
          #a8a8a8 4px
        );
      border-left: 1px solid #000;
    }

    .window-scrollable::-webkit-scrollbar-thumb {
      background: #fff;
      border: 1px solid #000;
    }

    /* Finder Window */
    .finder-window {
      top: 60px;
      left: 40px;
      width: 400px;
    }

    .finder-content {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      padding: 16px;
    }

    .finder-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
    }

    .finder-item:hover .finder-label {
      background: #000;
      color: #fff;
    }

    .folder-icon {
      width: 32px;
      height: 26px;
      background: #fff;
      border: 1px solid #000;
      position: relative;
      margin-bottom: 4px;
    }

    .folder-icon::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 2px;
      width: 14px;
      height: 6px;
      background: #fff;
      border: 1px solid #000;
      border-bottom: none;
    }

    .document-icon {
      width: 24px;
      height: 32px;
      background: #fff;
      border: 1px solid #000;
      position: relative;
      margin-bottom: 4px;
    }

    .document-icon::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 8px;
      height: 8px;
      background: #fff;
      border-left: 1px solid #000;
      border-bottom: 1px solid #000;
    }

    .finder-label {
      font-size: 10px;
      text-align: center;
      padding: 1px 3px;
    }

    /* About Window */
    .about-window {
      top: 120px;
      left: 120px;
      width: 340px;
    }

    .about-content {
      text-align: center;
      padding: 24px;
    }

    .macket-icon {
      width: 64px;
      height: 80px;
      margin: 0 auto 16px;
      border: 2px solid #000;
      background: #fff;
      position: relative;
    }

    .macket-screen {
      width: 48px;
      height: 36px;
      border: 2px solid #000;
      margin: 8px auto 4px;
      background: #a8a8a8;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .macket-screen::before {
      content: ':-)';
      font-size: 10px;
    }

    .macket-base {
      width: 56px;
      height: 8px;
      background: #fff;
      border-top: 2px solid #000;
      margin: 0 auto;
    }

    .about-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .about-text {
      font-size: 11px;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .about-divider {
      border: none;
      border-top: 1px solid #000;
      margin: 12px 0;
    }

    /* Button */
    .macket-button {
      background: #fff;
      border: 2px solid #000;
      border-radius: 8px;
      padding: 4px 16px;
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 2px 2px 0 #000;
    }

    .macket-button:active {
      background: #000;
      color: #fff;
      box-shadow: none;
      transform: translate(2px, 2px);
    }

    /* Trash Icon */
    .trash-icon {
      width: 28px;
      height: 32px;
      background: #fff;
      border: 1px solid #000;
      position: relative;
    }

    .trash-icon::before {
      content: '';
      position: absolute;
      top: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 4px;
      background: #fff;
      border: 1px solid #000;
    }

    .trash-icon::after {
      content: '';
      position: absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 18px;
      border-left: 1px solid #000;
      border-right: 1px solid #000;
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent 4px,
        #000 4px,
        #000 5px
      );
    }

    /* Floppy disk icon */
    .floppy-icon {
      width: 30px;
      height: 32px;
      background: #fff;
      border: 1px solid #000;
      position: relative;
    }

    .floppy-icon::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 18px;
      height: 10px;
      background: #a8a8a8;
      border: 1px solid #000;
    }

    .floppy-icon::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 12px;
      background: #fff;
      border: 1px solid #000;
    }

    /* HyperCard */
    .hypercard-content {
      padding: 0;
      background: #fff;
    }

    .hypercard-card {
      padding: 16px;
      min-height: 200px;
      border-bottom: 2px solid #000;
    }

    .hypercard-title {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 16px;
      text-decoration: underline;
    }

    .hypercard-text {
      font-size: 12px;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .hypercard-button {
      background: #fff;
      border: 2px solid #000;
      border-radius: 6px;
      padding: 6px 16px;
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      margin: 4px;
      box-shadow: 1px 1px 0 #000;
    }

    .hypercard-button:active {
      background: #000;
      color: #fff;
    }

    .hypercard-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: #e0e0e0;
      border-top: 1px solid #000;
    }

    .hypercard-nav-btn {
      background: #fff;
      border: 1px solid #000;
      padding: 4px 12px;
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
    }

    .hypercard-nav-btn:hover {
      background: #000;
      color: #fff;
    }

    .hypercard-page {
      font-size: 10px;
    }

    /* Tabbed Window */
    .tabbed-window {
      position: fixed;
      background: #fff;
      border: 1px solid #000;
      padding: 5px;
      display: flex;
      flex-direction: column;
    }

    .tabbed-window-inner {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
    }

    .tabbed-window-tabs {
      display: flex;
      background: #c0c0c0;
      border: 2px solid #000;
      min-height: 24px;
    }

    .tabbed-window-tab {
      padding: 4px 16px;
      background: #e0e0e0;
      border-right: 1px solid #000;
      font-size: 11px;
      cursor: pointer;
      position: relative;
      padding-left: 20px;
    }

    .tabbed-window-tab:hover {
      background: #fff;
    }

    .tabbed-window-tab.active {
      background: #fff;
      border-bottom: 2px solid #fff;
      margin-bottom: -2px;
    }

    .tab-close {
      display: none;
      position: absolute;
      left: 6px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      line-height: 1;
      cursor: pointer;
    }

    .tabbed-window-tab:hover .tab-close {
      display: block;
    }

    .tab-close:hover {
      font-weight: bold;
    }

    .tabbed-window-tab-add {
      padding: 4px 12px;
      background: #e0e0e0;
      border-right: 1px solid #000;
      font-size: 11px;
      cursor: pointer;
    }

    .tabbed-window-tab-add:hover {
      background: #fff;
    }

    .tabbed-close-box {
      margin: 4px 8px 4px 8px;
      align-self: center;
    }

    .first-tab-with-close {
      border-left: 1px solid #000;
    }

    .tabbed-window-content {
      flex: 1;
      background: #fff;
      overflow: hidden;
      display: flex;
    }

    /* Panes */
    .pane {
      flex: 1;
      display: flex;
      background: #fff;
      overflow: auto;
      cursor: pointer;
    }

    .pane-multi {
      margin: 2px;
      border: 1px solid #000;
      position: relative;
      overflow: visible;
    }

    .pane-split-vertical > .pane-multi,
    .pane-split-vertical > .pane-split {
      margin-top: 8px;
    }

    .pane-split-vertical > .pane-multi:first-child,
    .pane-split-vertical > .pane-split:first-child {
      margin-top: 0;
    }

    .tabbed-window-content > .pane-split {
      padding-top: 8px;
    }

    .pane-multi.focused {
      border: 2px solid teal;
    }

    .pane-title {
      position: absolute;
      top: -8px;
      left: 8px;
      background: #fff;
      padding: 0 4px;
      font-size: 10px;
      font-weight: bold;
      line-height: 1;
    }

    .pane-content {
      flex: 1;
      padding: 8px;
      overflow: auto;
    }

    .pane-multi .pane-content {
      padding-top: 12px;
    }

    .pane-split {
      flex: 1;
      display: flex;
    }

    .pane-split-vertical {
      flex-direction: column;
    }

    .pane-split-horizontal {
      flex-direction: row;
    }
  </style>
</head>
<body>
  <!-- Menu Bar -->
  <div class="menu-bar">
    <div class="menu-bar-left">
      <div class="menu-item-container">
        <span class="menu-item menu-item-bold" id="active-window-menu"></span>
        <div class="menu-dropdown" id="active-window-dropdown"></div>
      </div>
    </div>
    <div class="menu-bar-right">
      <div class="menu-item-container">
        <span class="menu-item" id="applications-menu">Applications</span>
        <div class="menu-dropdown" id="applications-dropdown"></div>
      </div>
      <span class="menu-item">Help</span>
      <span class="menu-item">Settings</span>
      <span class="menu-item">Logout</span>
    </div>
  </div>

  <!-- Desktop -->
  <div class="desktop" id="desktop">
    <!-- Windows are rendered dynamically -->
  </div>

  <script>
    // Initial windows configuration
    const initialWindows = [
      {
        id: 'tabbed-main',
        title: 'Main',
        tabbed: true,
        draggable: false,
        closeable: true,
        zIndex: 50,
        top: 20,
        left: 20,
        right: 20,
        bottom: 20,
        tabs: [
          { id: 'tab-1', name: 'Tab 1', panes: { id: 'pane-1', title: 'Pane 1', content: '' } }
        ],
        contextMenu: [
          { label: 'Split Vertical', action: 'split-vertical' },
          { label: 'Split Horizontal', action: 'split-horizontal' },
          { label: 'Close Pane', action: 'close-pane' },
          { label: 'Close', action: 'close' }
        ]
      },
      {
        id: 'finder',
        title: 'Marketbuffer HD',
        draggable: false,
        closeable: true,
        zIndex: 100,
        top: 80,
        right: 20,
        width: 400,
        contextMenu: [
          { label: 'Close', action: 'close' }
        ],
        content: `
          <div class="finder-content">
            <div class="finder-item">
              <div class="folder-icon"></div>
              <span class="finder-label">System</span>
            </div>
            <div class="finder-item">
              <div class="folder-icon"></div>
              <span class="finder-label">Applications</span>
            </div>
            <div class="finder-item">
              <div class="folder-icon"></div>
              <span class="finder-label">Documents</span>
            </div>
            <div class="finder-item">
              <div class="folder-icon"></div>
              <span class="finder-label">Utilities</span>
            </div>
            <div class="finder-item">
              <div class="document-icon"></div>
              <span class="finder-label">ReadMe</span>
            </div>
            <div class="finder-item">
              <div class="document-icon"></div>
              <span class="finder-label">Notes.txt</span>
            </div>
          </div>
        `
      },
      {
        id: 'about',
        title: 'About This Marketbuffer',
        draggable: true,
        closeable: true,
        zIndex: 101,
        top: 250,
        right: 40,
        width: 340,
        contextMenu: [
          { label: 'Close', action: 'close' }
        ],
        content: `
          <div class="about-content">
            <div class="macket-icon">
              <div class="macket-screen"></div>
              <div class="macket-base"></div>
            </div>
            <div class="about-title">Marketbuffer System</div>
            <div class="about-text">
              System Software 7.0<br>
              &copy; Marketbuffer Computer, Inc. 2025-2026
            </div>
            <hr class="about-divider">
            <div class="about-text">
              Built-in Memory: 4,096K<br>
              Total Memory: 8,192K
            </div>
            <br>
            <button class="macket-button">OK</button>
          </div>
        `
      },
      {
        id: 'hypercard',
        title: 'HyperCard - Welcome Stack',
        draggable: true,
        closeable: true,
        zIndex: 102,
        top: 140,
        right: 440,
        width: 360,
        contextMenu: [
          { label: 'Close', action: 'close' }
        ],
        content: `
          <div class="hypercard-content">
            <div class="hypercard-card">
              <div class="hypercard-title">Welcome to HyperCard</div>
              <div class="hypercard-text">
                HyperCard is your gateway to creating interactive stacks of information.
              </div>
              <div class="hypercard-text">
                Click the buttons below to explore:
              </div>
              <div style="text-align: center; margin-top: 20px;">
                <button class="hypercard-button">Browse</button>
                <button class="hypercard-button">Create</button>
                <button class="hypercard-button">Learn</button>
              </div>
            </div>
            <div class="hypercard-nav">
              <button class="hypercard-nav-btn">&larr; Prev</button>
              <span class="hypercard-page">Card 1 of 3</span>
              <button class="hypercard-nav-btn">Next &rarr;</button>
            </div>
          </div>
        `
      }
    ];

    // Open windows list (copy from initial on load)
    let openWindows = [];

    // Active window ID
    let activeWindowId = null;

    // Focused pane ID
    let focusedPaneId = null;

    // Dragging state
    let activeWindow = null;
    let offsetX = 0;
    let offsetY = 0;

    // LocalStorage key
    const STORAGE_KEY = 'marketbuffer_windows_state';

    // Save state to localStorage
    function saveState() {
      const state = openWindows.map(win => ({
        id: win.id,
        zIndex: win.zIndex,
        top: win.top,
        left: win.left,
        right: win.right,
        bottom: win.bottom,
        activeTab: win.activeTab,
        tabs: win.tabs
      }));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // Load state from localStorage
    function loadState() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          const state = JSON.parse(saved);
          // Merge saved state with initial windows (to get non-serialized properties)
          openWindows = state.map(savedWin => {
            const initialWin = initialWindows.find(w => w.id === savedWin.id);
            if (initialWin) {
              return { ...initialWin, ...savedWin };
            }
            return null;
          }).filter(Boolean);
          return true;
        } catch (e) {
          console.error('Failed to load state:', e);
        }
      }
      return false;
    }

    // Initialize on page load
    function init() {
      // Try to load from localStorage, otherwise use initial windows
      if (!loadState()) {
        openWindows = initialWindows.map(win => ({ ...win }));
      }
      renderWindows();

      // Set initial active window to the one with highest zIndex
      if (openWindows.length > 0) {
        const topWindow = openWindows.reduce((a, b) => a.zIndex > b.zIndex ? a : b);
        activeWindowId = topWindow.id;
        updateActiveWindowMenu();
      }
    }

    // Render panes recursively
    function renderPanes(pane, isMultiple = false) {
      if (pane.direction) {
        // Split pane - children are in multiple pane mode
        const dirClass = pane.direction === 'vertical' ? 'pane-split-vertical' : 'pane-split-horizontal';
        const childrenHtml = pane.children.map(child => renderPanes(child, true)).join('');
        return `<div class="pane-split ${dirClass}">${childrenHtml}</div>`;
      } else {
        // Leaf pane
        const multiClass = isMultiple ? 'pane-multi' : '';
        const focusedClass = isMultiple && pane.id === focusedPaneId ? 'focused' : '';
        const titleHtml = isMultiple && pane.title ? `<div class="pane-title">${pane.title}</div>` : '';
        return `<div class="pane ${multiClass} ${focusedClass}" data-pane-id="${pane.id}">${titleHtml}<div class="pane-content">${pane.content || ''}</div></div>`;
      }
    }

    // Render all open windows
    function renderWindows() {
      const desktop = document.getElementById('desktop');
      desktop.innerHTML = '';

      openWindows.forEach((win, index) => {
        const windowEl = document.createElement('div');

        const menuBarHeight = 20;

        if (win.tabbed) {
          // Tabbed window - no title bar, positioned relative to viewport below menu bar
          windowEl.className = 'tabbed-window';
          windowEl.id = 'tabbed-window';
          windowEl.dataset.windowId = win.id;
          windowEl.style.zIndex = win.zIndex;
          windowEl.style.top = (win.top + menuBarHeight) + 'px';
          windowEl.style.left = win.left + 'px';
          windowEl.style.right = win.right + 'px';
          windowEl.style.bottom = win.bottom + 'px';

          // Render tabs
          const activeTab = win.activeTab || 0;
          const tabsHtml = win.tabs.map((tab, i) => {
            const isFirst = i === 0 && win.closeable;
            const classes = `tabbed-window-tab ${i === activeTab ? 'active' : ''} ${isFirst ? 'first-tab-with-close' : ''}`;
            return `<div class="${classes}" data-tab-index="${i}">${tab.name}<span class="tab-close" data-tab-index="${i}">&times;</span></div>`;
          }).join('');

          // Close button for closeable tabbed windows
          const closeBoxHtml = win.closeable
            ? `<div class="close-box tabbed-close-box" data-window-id="${win.id}"></div>`
            : '';

          // Render panes for active tab
          const activeTabData = win.tabs[activeTab];
          const panesHtml = activeTabData?.panes ? renderPanes(activeTabData.panes) : '';

          windowEl.innerHTML = `
            <div class="tabbed-window-inner">
              <div class="tabbed-window-tabs" id="tabbed-tabs">
                ${closeBoxHtml}
                ${tabsHtml}
                <div class="tabbed-window-tab-add" id="add-tab">+</div>
              </div>
              <div class="tabbed-window-content" id="tabbed-content">
                ${panesHtml}
              </div>
            </div>
          `;
        } else {
          // Regular window - positioned relative to viewport below menu bar
          windowEl.className = `window ${win.draggable ? 'window-draggable' : ''}`;
          windowEl.dataset.windowId = win.id;
          windowEl.style.top = (win.top + menuBarHeight) + 'px';
          windowEl.style.right = win.right + 'px';
          windowEl.style.width = win.width + 'px';
          windowEl.style.zIndex = win.zIndex;

          const closeBoxHtml = win.closeable
            ? `<div class="close-box" data-window-id="${win.id}"></div>`
            : '';

          windowEl.innerHTML = `
            <div class="window-title-bar">
              ${closeBoxHtml}
              <span class="window-title">${win.title}</span>
            </div>
            ${win.content}
          `;
        }

        desktop.appendChild(windowEl);
      });

      attachEventListeners();
      setupTabbedWindowListeners();
    }

    // Attach event listeners after rendering
    function attachEventListeners() {
      // Close button handlers
      document.querySelectorAll('.close-box').forEach(closeBox => {
        closeBox.addEventListener('click', (e) => {
          const windowId = e.target.dataset.windowId;
          closeWindow(windowId);
        });
      });

      // Draggable window handlers
      document.querySelectorAll('.window-draggable .window-title-bar').forEach(titleBar => {
        titleBar.addEventListener('mousedown', (e) => {
          if (e.target.classList.contains('close-box')) return;

          activeWindow = titleBar.closest('.window');
          const rect = activeWindow.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;

          // Bring window to front
          bringToFront(activeWindow);
        });
      });

      // Click to bring window to front (all windows, not just draggable)
      document.querySelectorAll('.window').forEach(win => {
        win.addEventListener('mousedown', () => {
          bringToFront(win);
        });
      });
    }

    // Close a window (only if closeable)
    function closeWindow(windowId) {
      const win = openWindows.find(w => w.id === windowId);
      if (win && !win.closeable) return; // Can't close non-closeable windows
      openWindows = openWindows.filter(win => win.id !== windowId);

      // Update active window if the closed window was active
      if (activeWindowId === windowId) {
        if (openWindows.length > 0) {
          const topWindow = openWindows.reduce((a, b) => a.zIndex > b.zIndex ? a : b);
          activeWindowId = topWindow.id;
        } else {
          activeWindowId = null;
        }
        updateActiveWindowMenu();
      }

      saveState();
      renderWindows();
    }

    // Bring window to front
    function bringToFront(windowEl) {
      const windowId = windowEl.dataset.windowId;

      // Update zIndex in openWindows array
      openWindows.forEach(w => {
        if (w.tabbed) {
          w.zIndex = 50;
        } else {
          w.zIndex = 100;
        }
      });
      const win = openWindows.find(w => w.id === windowId);
      if (win) win.zIndex = 200;

      // Update DOM
      document.querySelectorAll('.window').forEach(w => w.style.zIndex = 100);
      const tabbedWin = document.getElementById('tabbed-window');
      if (tabbedWin) tabbedWin.style.zIndex = 50;
      windowEl.style.zIndex = 200;

      // Set active window
      activeWindowId = windowId;
      updateActiveWindowMenu();

      saveState();
    }

    // Bring tabbed window to front
    function bringTabbedToFront() {
      // Update zIndex in openWindows array
      const tabbedWindow = openWindows.find(w => w.tabbed);
      openWindows.forEach(w => {
        if (w.tabbed) {
          w.zIndex = 200;
        } else {
          w.zIndex = 100;
        }
      });

      // Update DOM
      document.querySelectorAll('.window').forEach(w => w.style.zIndex = 100);
      const tabbedWin = document.getElementById('tabbed-window');
      if (tabbedWin) tabbedWin.style.zIndex = 200;

      // Set active window
      if (tabbedWindow) {
        activeWindowId = tabbedWindow.id;
        updateActiveWindowMenu();
      }

      saveState();
    }

    // Mouse move handler for dragging
    const menuBarHeight = 20;
    document.addEventListener('mousemove', (e) => {
      if (!activeWindow) return;

      const y = e.clientY - offsetY;
      const windowWidth = activeWindow.offsetWidth;
      const rightPos = window.innerWidth - e.clientX - (windowWidth - offsetX);

      // Keep window within viewport (below menu bar)
      const minY = menuBarHeight;
      const actualTop = Math.max(minY, y);
      activeWindow.style.right = Math.max(0, rightPos) + 'px';
      activeWindow.style.top = actualTop + 'px';

      // Update position in openWindows array (store relative to viewport, not absolute)
      const windowId = activeWindow.dataset.windowId;
      const win = openWindows.find(w => w.id === windowId);
      if (win) {
        win.right = Math.max(0, rightPos);
        win.top = actualTop - menuBarHeight; // Store relative to viewport
      }
    });

    document.addEventListener('mouseup', () => {
      if (activeWindow) {
        saveState();
      }
      activeWindow = null;
    });

    // Initialize
    init();

    // Tabbed window functions
    function switchTab(tabIndex) {
      const tabbedWin = openWindows.find(w => w.tabbed);
      if (tabbedWin) {
        tabbedWin.activeTab = tabIndex;
        saveState();
        renderWindows();
      }
    }

    // Pane ID counter
    let paneIdCounter = 1;

    // Collect all pane IDs from a pane tree
    function collectPaneIds(pane, ids = []) {
      if (!pane) return ids;
      if (pane.direction) {
        // Split pane - recurse into children
        pane.children.forEach(child => collectPaneIds(child, ids));
      } else {
        // Leaf pane
        ids.push(pane.id);
      }
      return ids;
    }

    // Get all active pane IDs across all tabs and windows
    function getAllActivePaneIds() {
      const allIds = [];
      openWindows.forEach(win => {
        if (win.tabs) {
          win.tabs.forEach(tab => {
            if (tab.panes) {
              collectPaneIds(tab.panes, allIds);
            }
          });
        }
      });
      return allIds;
    }

    function generatePaneId() {
      const activeIds = getAllActivePaneIds();
      // Find an unused pane ID
      while (activeIds.includes(`pane-${paneIdCounter}`)) {
        paneIdCounter++;
      }
      return `pane-${paneIdCounter++}`;
    }

    function addTab() {
      const tabbedWin = openWindows.find(w => w.tabbed);
      if (tabbedWin) {
        const newIndex = tabbedWin.tabs.length;
        const newPaneId = generatePaneId();
        tabbedWin.tabs.push({
          id: `tab-${newIndex + 1}`,
          name: `Tab ${newIndex + 1}`,
          panes: { id: newPaneId, title: `Pane ${paneIdCounter}`, content: '' }
        });
        tabbedWin.activeTab = newIndex;
        saveState();
        renderWindows();
      }
    }

    function closeTab(tabIndex) {
      const tabbedWin = openWindows.find(w => w.tabbed);
      if (tabbedWin) {
        tabbedWin.tabs.splice(tabIndex, 1);

        // If no tabs left, close the window
        if (tabbedWin.tabs.length === 0) {
          openWindows = openWindows.filter(w => w.id !== tabbedWin.id);
        } else {
          // Adjust active tab if needed
          if (tabbedWin.activeTab >= tabbedWin.tabs.length) {
            tabbedWin.activeTab = tabbedWin.tabs.length - 1;
          } else if (tabbedWin.activeTab > tabIndex) {
            tabbedWin.activeTab--;
          }
        }
        saveState();
        renderWindows();
      }
    }

    // Setup tabbed window listeners
    function setupTabbedWindowListeners() {
      const tabbedWin = document.getElementById('tabbed-window');
      if (tabbedWin) {
        tabbedWin.addEventListener('mousedown', bringTabbedToFront);
      }

      // Tab click handlers
      document.querySelectorAll('.tabbed-window-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          // Don't switch tab if clicking on close button
          if (e.target.classList.contains('tab-close')) return;
          const tabIndex = parseInt(tab.dataset.tabIndex);
          switchTab(tabIndex);
        });
      });

      // Tab close button handlers
      document.querySelectorAll('.tab-close').forEach(closeBtn => {
        closeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const tabIndex = parseInt(closeBtn.dataset.tabIndex);
          closeTab(tabIndex);
        });
      });

      // Add tab button
      const addBtn = document.getElementById('add-tab');
      if (addBtn) {
        addBtn.addEventListener('click', addTab);
      }

      // Pane click handlers
      document.querySelectorAll('.pane').forEach(pane => {
        pane.addEventListener('click', (e) => {
          e.stopPropagation();
          const paneId = pane.dataset.paneId;
          focusPane(paneId);
        });
      });
    }

    function focusPane(paneId) {
      focusedPaneId = paneId;
      // Update UI without full re-render - only apply to multi-pane
      document.querySelectorAll('.pane-multi').forEach(p => {
        if (p.dataset.paneId === paneId) {
          p.classList.add('focused');
        } else {
          p.classList.remove('focused');
        }
      });
    }

    // Active window menu
    function updateActiveWindowMenu() {
      const menuItem = document.getElementById('active-window-menu');
      const win = openWindows.find(w => w.id === activeWindowId);
      if (win) {
        menuItem.textContent = win.title;
      } else {
        menuItem.textContent = '';
      }
    }

    function renderActiveWindowDropdown() {
      const dropdown = document.getElementById('active-window-dropdown');
      dropdown.innerHTML = '';

      const win = openWindows.find(w => w.id === activeWindowId);
      if (!win || !win.contextMenu) return;

      win.contextMenu.forEach(item => {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-dropdown-item';
        menuItem.textContent = item.label;
        menuItem.addEventListener('click', () => {
          executeContextMenuAction(win.id, item.action);
          closeActiveWindowMenu();
        });
        dropdown.appendChild(menuItem);
      });
    }

    function executeContextMenuAction(windowId, action) {
      if (action === 'close') {
        closeWindow(windowId);
      } else if (action === 'split-vertical') {
        splitPane(windowId, 'vertical');
      } else if (action === 'split-horizontal') {
        splitPane(windowId, 'horizontal');
      } else if (action === 'close-pane') {
        closePane(windowId);
      }
    }

    // Find and replace a pane by ID in the pane tree
    function findAndReplacePaneById(pane, targetId, replacement) {
      if (!pane.direction) {
        // Leaf pane
        if (pane.id === targetId) {
          return { found: true, result: replacement };
        }
        return { found: false, result: pane };
      }

      // Split pane - search children
      let found = false;
      const newChildren = pane.children.map(child => {
        if (found) return child;
        const result = findAndReplacePaneById(child, targetId, replacement);
        if (result.found) {
          found = true;
          return result.result;
        }
        return result.result;
      });

      return { found, result: { ...pane, children: newChildren } };
    }

    // Split the focused pane
    function splitPane(windowId, direction) {
      const win = openWindows.find(w => w.id === windowId);
      if (!win || !win.tabbed) return;

      const activeTab = win.activeTab || 0;
      const tab = win.tabs[activeTab];
      if (!tab || !tab.panes) return;

      // If no pane is focused, focus the first leaf pane
      if (!focusedPaneId) {
        const firstLeaf = findFirstLeafPane(tab.panes);
        if (firstLeaf) focusedPaneId = firstLeaf.id;
      }

      if (!focusedPaneId) return;

      // Find the focused pane and get its data
      const focusedPane = findPaneById(tab.panes, focusedPaneId);
      if (!focusedPane) return;

      // Create replacement split with original pane and new pane
      const newPaneId = generatePaneId();
      const newPane = { id: newPaneId, title: `Pane ${paneIdCounter}`, content: '' };
      const replacement = {
        direction: direction,
        children: [
          { ...focusedPane },
          newPane
        ]
      };

      // Replace focused pane with the new split
      const result = findAndReplacePaneById(tab.panes, focusedPaneId, replacement);
      tab.panes = result.result;

      // Focus the new pane
      focusedPaneId = newPaneId;

      saveState();
      renderWindows();
    }

    // Find a pane by ID
    function findPaneById(pane, id) {
      if (!pane.direction) {
        return pane.id === id ? pane : null;
      }
      for (const child of pane.children) {
        const found = findPaneById(child, id);
        if (found) return found;
      }
      return null;
    }

    // Find first leaf pane
    function findFirstLeafPane(pane) {
      if (!pane.direction) {
        return pane;
      }
      return findFirstLeafPane(pane.children[0]);
    }

    // Close the focused pane and collapse its parent split
    function closePane(windowId) {
      const win = openWindows.find(w => w.id === windowId);
      if (!win || !win.tabbed) return;

      const activeTab = win.activeTab || 0;
      const tab = win.tabs[activeTab];
      if (!tab || !tab.panes) return;

      // Can't close if it's the only pane (no splits)
      if (!tab.panes.direction) return;

      if (!focusedPaneId) {
        const firstLeaf = findFirstLeafPane(tab.panes);
        if (firstLeaf) focusedPaneId = firstLeaf.id;
      }

      if (!focusedPaneId) return;

      // Remove the pane and collapse the split
      const result = removePaneById(tab.panes, focusedPaneId);
      if (result.removed) {
        tab.panes = result.result;

        // Focus the first remaining pane
        const firstLeaf = findFirstLeafPane(tab.panes);
        focusedPaneId = firstLeaf ? firstLeaf.id : null;

        saveState();
        renderWindows();
      }
    }

    // Remove a pane by ID and collapse the parent split
    function removePaneById(pane, targetId) {
      if (!pane.direction) {
        // Leaf pane - can't remove from here
        return { removed: false, result: pane };
      }

      // Check if one of the children is the target
      const targetIndex = pane.children.findIndex(child =>
        !child.direction && child.id === targetId
      );

      if (targetIndex !== -1) {
        // Found the target - return the sibling
        const siblingIndex = targetIndex === 0 ? 1 : 0;
        return { removed: true, result: pane.children[siblingIndex] };
      }

      // Recursively search in children
      let removed = false;
      const newChildren = pane.children.map(child => {
        if (removed) return child;
        const result = removePaneById(child, targetId);
        if (result.removed) {
          removed = true;
          return result.result;
        }
        return result.result;
      });

      return { removed, result: { ...pane, children: newChildren } };
    }

    function toggleActiveWindowMenu() {
      const dropdown = document.getElementById('active-window-dropdown');
      const isOpen = dropdown.classList.contains('open');
      if (isOpen) {
        closeActiveWindowMenu();
      } else {
        renderActiveWindowDropdown();
        dropdown.classList.add('open');
      }
    }

    function closeActiveWindowMenu() {
      const dropdown = document.getElementById('active-window-dropdown');
      dropdown.classList.remove('open');
    }

    // Applications menu
    function renderApplicationsMenu() {
      const dropdown = document.getElementById('applications-dropdown');
      dropdown.innerHTML = '';

      initialWindows.forEach(win => {
        const isOpen = openWindows.some(w => w.id === win.id);
        const item = document.createElement('div');
        item.className = `menu-dropdown-item ${isOpen ? 'checked' : ''}`;
        item.textContent = win.title;
        item.dataset.windowId = win.id;
        item.addEventListener('click', () => {
          openApplication(win.id);
          closeApplicationsMenu();
        });
        dropdown.appendChild(item);
      });
    }

    function openApplication(windowId) {
      const isOpen = openWindows.some(w => w.id === windowId);
      if (!isOpen) {
        const win = initialWindows.find(w => w.id === windowId);
        if (win) {
          // Reset all z-indexes
          openWindows.forEach(w => {
            w.zIndex = w.tabbed ? 50 : 100;
          });
          // Add new window with highest z-index
          const newWin = { ...win, zIndex: 200 };
          openWindows.push(newWin);
          // Set as active window
          activeWindowId = windowId;
          saveState();
          renderWindows();
          updateActiveWindowMenu();
        }
      }
    }

    function toggleApplicationsMenu() {
      const dropdown = document.getElementById('applications-dropdown');
      const isOpen = dropdown.classList.contains('open');
      if (isOpen) {
        closeApplicationsMenu();
      } else {
        renderApplicationsMenu();
        dropdown.classList.add('open');
      }
    }

    function closeApplicationsMenu() {
      const dropdown = document.getElementById('applications-dropdown');
      dropdown.classList.remove('open');
    }

    // Active window menu event listeners
    document.getElementById('active-window-menu').addEventListener('click', (e) => {
      e.stopPropagation();
      closeApplicationsMenu();
      toggleActiveWindowMenu();
    });

    // Applications menu event listeners
    document.getElementById('applications-menu').addEventListener('click', (e) => {
      e.stopPropagation();
      closeActiveWindowMenu();
      toggleApplicationsMenu();
    });

    document.addEventListener('click', () => {
      closeApplicationsMenu();
      closeActiveWindowMenu();
    });
  </script>
</body>
</html>
